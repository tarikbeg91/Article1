<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Reader Pro (Full Feature Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mozilla/readability@0.5.0/Readability.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Lora:ital,wght@0,400..700;1,400..700&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Lexend+Deca:wght@100..900&display=swap');

        :root {
            --bg-color: #f4f7f6; --text-color: #333; --container-bg: #ffffff;
            --primary-color: #007bff; --secondary-color: #17a2b8;
            --border-color: #ddd; --danger-color: #dc3545; --success-color: #28a745;
            --font-size-base: 16px; --line-height-base: 1.6;
            --player-red: #d32f2f; --player-gold: #bcaaa4; --player-light-gray: #e0e0e0;
            --article-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dark-mode {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e;
            --primary-color: #4dabf7; --secondary-color: #4dd0e1;
            --border-color: #444; --danger-color: #e57373; --success-color: #66bb6a;
            --player-red: #e57373; --player-gold: #90a4ae; --player-light-gray: #424242;
        }
        .sepia-mode {
            --bg-color: #f4e8c1; --text-color: #5b4636; --container-bg: #fbf0d9;
            --primary-color: #795548; --secondary-color: #8d6e63;
            --border-color: #d7ccc8; --danger-color: #a1887f; --success-color: #7cb342;
            --player-red: #8d6e63; --player-gold: #a1887f; --player-light-gray: #d7ccc8;
        }
        .high-contrast-mode {
            --bg-color: #000000; --text-color: #FFFFFF; --container-bg: #0a0a0a;
            --primary-color: #FFFF00; --secondary-color: #00FFFF; --border-color: #AAAAAA;
            --danger-color: #FF4136; --success-color: #01FF70;
            --player-red: #FF4136; --player-gold: #00FFFF; --player-light-gray: #333333;
        }
        .high-contrast-mode input, .high-contrast-mode select, .high-contrast-mode textarea {
             background-color: #111 !important; color: #FFF !important; border-color: #AAA !important;
        }
        .high-contrast-mode button.tool-btn,
        .high-contrast-mode .tool-btn-secondary:not(.danger-btn):not([style*="background-color: var(--success-color)"]) {
            color: #000000 !important;
        }
        .high-contrast-mode .tool-btn-secondary { background-color: var(--secondary-color) !important; }
        .high-contrast-mode button.tool-btn { background-color: var(--primary-color) !important; }
        .high-contrast-mode .danger-btn { background-color: var(--danger-color) !important; color: #FFF !important; }
        .high-contrast-mode button[style*="background-color: var(--success-color)"]{ background-color: var(--success-color) !important; color: #000 !important; }
        .high-contrast-mode .theme-toggle { background-color: #222 !important; color: #FFF !important; border-color: #AAA !important; }
        .high-contrast-mode #clearUrlBtn { background-color: var(--danger-color) !important; color: #FFF !important; }
        .high-contrast-mode .header-buttons button { background-color: var(--secondary-color) !important; color: #000 !important; }
        .high-contrast-mode .header-buttons .save-btn.saved { background-color: var(--danger-color) !important; color: #FFF !important; }
        .high-contrast-mode .header-buttons button[title*="शेयर करें"],
        .high-contrast-mode #shareLibArticleBtn { background-color: var(--success-color) !important; color: #000 !important; }
        .high-contrast-mode .original-view-btn,
        .high-contrast-mode #toggleOriginalViewLibBtn { background-color: var(--secondary-color) !important; color: #000 !important; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: var(--line-height-base); transition: background-color 0.3s, color 0.3s; margin: 0; padding-top: 5px; }
        body.audio-only #library-youtube-iframe-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }

        #progress-bar { position: fixed; top: 0; left: 0; height: 5px; background: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.1s; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: var(--primary-color); }
        .tabs { border-bottom: 2px solid var(--border-color); overflow: hidden; margin-bottom: 20px; display: flex; flex-wrap: wrap; }
        .tab-link { background: transparent; border: none; cursor: pointer; padding: 14px 16px; font-size: 17px; color: var(--text-color); border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        input[type="url"], input[type="search"], input[type="text"], select, textarea { background-color: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        button.tool-btn, .tool-btn-secondary { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .tool-btn-secondary { background-color: var(--secondary-color); margin-left: 10px; }
        .danger-btn { background-color: var(--danger-color) !important; }
        #clearUrlBtn { height: 46.4px; margin-top: 10px; font-size: 1.2em; background-color: var(--danger-color); color:white; border-radius:6px; border:none; cursor:pointer; padding: 0 12px;}
        .result-box { background-color: var(--bg-color); margin-top: 15px; padding: 15px; border-radius: 6px; font-size: var(--font-size-base); }
        .single-story { border-bottom: 2px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .single-story:last-child { border-bottom: none; margin-bottom: 0; }
        .single-story img { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; }
        .story-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .header-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
        .header-buttons button { background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
        .header-buttons .save-btn.saved { background-color: var(--danger-color); }
        .original-view-btn { padding: 6px 10px !important; font-size: 14px !important;}
        .theme-toggle-container { position: fixed; top: 15px; right: 20px; z-index: 10001; display:flex; gap: 5px;}
        .theme-toggle { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; }
        #ae_loading { margin-top: 15px; color: var(--primary-color); font-style: italic; text-align: center; }
        .library-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .library-item .item-title { flex-grow: 1; cursor: pointer; }
        .library-item .item-controls { display: flex; align-items: center; gap: 8px; }
        .library-item .read-status-toggle { cursor: pointer; font-size: 1.1em; padding: 0 5px; }
        .library-item.selected { background-color: var(--border-color); }
        .library-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .item-more-options-btn { background: transparent; border: none; color: var(--text-color); font-size: 1.5em; cursor: pointer; padding: 0 8px; line-height: 1; }
        .item-context-menu { position: absolute; background-color: var(--container-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1005; display: none; padding: 5px 0; font-size: 0.9em; }
        .item-context-menu button { background: none; border: none; color: var(--text-color); padding: 8px 16px; width: 100%; text-align: left; cursor: pointer; }
        .item-context-menu button:hover { background-color: var(--bg-color); }

        #ae_result .article-body-content,
        #lib-article-text-content,
        .youtube-transcript-content {
            font-family: var(--article-font-family);
            white-space: pre-wrap;
            line-height: 1.7;
        }
        #lib-article-text-content, #lib-content-area .youtube-view-library {
            background-color: var(--bg-color); padding: 15px; border-radius: 6px;
            max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color);
        }
        .article-body-content, .youtube-video-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .youtube-video-container iframe {
            width: 100%;
            min-height: 450px;
            border: none;
            border-radius: 8px;
        }
        .youtube-transcript-content {
            margin-top: 15px; padding: 10px; border: 1px dashed var(--border-color);
            border-radius: 6px; max-height: 300px; overflow-y: auto;
        }

        #lib-article-webview-container { margin-top: 15px;}
        #lib-article-iframe { width:100%; height:80vh; border:1px solid var(--border-color); }
        .original-webview-iframe { width:100%; height:70vh; border:1px solid var(--border-color); margin-top:15px; }

        .reading-progress-container {
            position: sticky; top: 0; left: 0; width: 100%; height: 5px;
            background-color: var(--border-color); z-index: 100; display: none;
        }
        .reading-progress-bar { height: 100%; width: 0%; background-color: var(--primary-color); transition: width 0.1s ease-out; }
        #library-reading-progress-container { z-index: 1000; }
        .extractor-reading-progress-container { margin-bottom: 5px; }

        #lib-article-current-tags .tag-item { background-color: var(--secondary-color); color: white; padding: 3px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; font-size: 0.9em; display: inline-block; }
        #lib-article-current-tags .tag-remove-btn { margin-left: 4px; border: none; background: transparent; color: white; cursor: pointer; font-weight: bold; }

        #audioPlayerContainer { display: none; flex-direction: column; gap: 10px; margin-top: 15px; padding: 15px; border-radius: 8px; background-color: var(--bg-color); border: 1px solid var(--border-color); }
        #audioPlayerContainer .visualizer-container { width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; }
        #audioPlayerContainer .progress-container { display: flex; align-items: center; gap: 10px; font-size: 0.8em; color: var(--text-color); }
        #audioPlayerContainer input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: var(--player-light-gray); outline: none; margin: 0; cursor: pointer; background-image: linear-gradient(var(--player-red), var(--player-red)); background-size: 0% 100%; background-repeat: no-repeat; }
        #audioPlayerContainer input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: var(--player-red); border-radius: 50%; cursor: pointer; }
        #audioPlayerContainer input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; background: var(--player-red); border-radius: 50%; cursor: pointer; border: none; }
        #audioPlayerContainer .controls-container { display: flex; justify-content: space-around; align-items: center; }
        #audioPlayerContainer .controls-container button { background: none; border: none; cursor: pointer; font-size: 1.8em; color: var(--player-gold); padding: 5px; }
        #audioPlayerContainer .controls-container button.play-pause-btn { background-color: var(--player-red); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5em; }
        #audioPlayerContainer .controls-container button:disabled { opacity: 0.4; cursor: not-allowed; }
        #audioPlayerContainer .controls-container button.active { color: var(--player-red); }

        .queue-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 10020; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .queue-modal-overlay.show { display: flex; opacity: 1; }
        .queue-modal-content { background-color: var(--container-bg); color: var(--text-color); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .queue-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .queue-modal-header h3 { margin: 0; color: var(--primary-color); }
        #queue-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .queue-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: grab; user-select: none; }
        .queue-item:last-child { border-bottom: none; }
        .queue-item.playing { font-weight: bold; color: var(--primary-color); background-color: var(--bg-color); }
        .queue-item.dragging { opacity: 0.5; background: var(--border-color); }
        .queue-item-title { flex-grow: 1; cursor: pointer; }
        .queue-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        /* Styles for Link Collector */
        .link-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; background-color: var(--bg-color); }
        .link-list-item .link-title { font-weight: bold; flex-grow: 1; margin-right: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .link-list-item .link-actions button { padding: 6px 10px; font-size: 0.9em; margin-left: 8px; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .link-list-item .link-actions button:hover { opacity: 0.8; }

        .settings-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 10010; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .settings-modal-overlay.show { opacity: 1; pointer-events: auto; }
        .settings-modal-content { background-color: var(--container-bg); color: var(--text-color); padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .settings-modal-overlay.show .settings-modal-content { transform: scale(1); }
        .settings-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .settings-modal-header h2 { margin: 0; color: var(--primary-color); }
        .settings-close-btn { background: transparent; border: none; font-size: 28px; font-weight: bold; color: var(--text-color); cursor: pointer; padding: 0 10px; }
        .settings-modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px; }
        .settings-modal-body fieldset { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .settings-modal-body legend { font-weight: bold; color: var(--primary-color); padding: 0 10px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label { flex-shrink: 0; }
        .setting-control { display: flex; gap: 15px; align-items: center; flex-grow: 1; justify-content: flex-end; }
        .setting-control button, .setting-control select { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 8px 12px; cursor: pointer; }
        .setting-control input[type="radio"] + label { cursor: pointer; }
        .setting-control input[type="checkbox"] { transform: scale(1.2); cursor: pointer;}
        .setting-control .danger-btn { background-color: var(--danger-color); color: white; }
        .setting-control .range-control { display: flex; align-items: center; gap: 10px; }
        .danger-zone { border-color: var(--danger-color); }
        .danger-zone legend { color: var(--danger-color); }
        .settings-modal-footer { border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px; text-align: right; }

        .fallback-share-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--container-bg); color: var(--text-color); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10050; width: 90%; max-width: 400px; }
        .fallback-share-modal textarea { width: calc(100% - 20px); min-height: 100px; margin-bottom: 10px; padding: 10px; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10060; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { background-color: var(--primary-color); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease, transform 0.3s ease; font-size: 0.9em; }
        .toast-notification.show { opacity: 1; transform: translateX(0); }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.warning { background-color: var(--player-gold); color: var(--text-color); }
        .toast-actions button { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; margin-left: 10px; border-radius: 4px; cursor: pointer; }

        #backToTopBtn { display: none; position: fixed; bottom: 20px; left: 20px; z-index: 99; border: none; outline: none; background-color: var(--primary-color); color: white; cursor: pointer; padding: 10px 15px; border-radius: 50%; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #backToTopBtn:hover { background-color: var(--secondary-color); }

        .library-playlist-controls { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .library-playlist-controls button { margin-left: 0 !important; }
        #libVoiceSelectorContainer, #voiceSelectorContainerSetting { display: flex; align-items: center; gap: 10px;}
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        .library-item input[type="checkbox"].playlist-checkbox { margin-right: 10px; transform: scale(1.2); cursor:pointer; }
        .bookmark-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .bookmark-item:last-child { border-bottom: none; }
        .bookmark-item .item-title { flex-grow: 1; cursor: pointer; }
        .bookmark-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        #bookmark-controls { margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
        #bookmark-controls input, #bookmark-controls select { margin-top:0; }
        #bookmark-list-container { margin-top:15px; }

        #rss-feed-controls { display:flex; gap:10px; align-items:flex-end; margin-bottom:15px; flex-wrap: wrap;}
        #rss-feed-controls input {flex-grow:1; margin-top:0;}
        #rss-feed-controls button {margin-top:0; padding:12px 15px; font-size:0.9em;}

        #subscribedFeedsList ul { list-style: none; padding-left: 0; }
        #subscribedFeedsList li { margin-bottom: 8px; padding: 8px; background-color: var(--bg-color); border-radius: 4px; display:flex; justify-content:space-between; align-items:center;}
        #subscribedFeedsList li a { color: var(--primary-color); text-decoration: none; font-weight: bold; flex-grow:1;}
        #subscribedFeedsList li a:hover { text-decoration: underline; }
        #rssArticlesContainer { border-top: 1px solid var(--border-color); margin-top:20px; padding-top:15px;}
        .rss-article-item { display: flex; align-items: flex-start; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .rss-article-item .item-title { cursor:pointer; flex-grow: 1; }
        .rss-article-item:last-child { border-bottom: none; }
        .rss-article-item:hover { background-color: var(--bg-color); }
        .rss-article-item small { color: var(--text-color); opacity: 0.7; font-size:0.8em;}
        .rss-article-item p {font-size: 0.9em; opacity: 0.8; margin-top: 5px; margin-bottom: 0;}

        .focus-mode-active .main-container > h1,
        .focus-mode-active #googleSearchContainer, .focus-mode-active #internalNavHistoryContainer, .focus-mode-active .tabs,
        .focus-mode-active #ArticleExtractor > p,
        .focus-mode-active #ArticleExtractor > div:not(.result-box):not(#ae_loading):not(.single-story .original-webview-container),
        .focus-mode-active #ArticleExtractor > button:not([onclick*="ae_startExtraction"]):not([onclick*="clearResults"]),
        .focus-mode-active #MyLibrary > h2, .focus-mode-active #MyLibrary > .library-controls,
        .focus-mode-active #MyLibrary > .library-playlist-controls, .focus-mode-active #library-list-container,
        .focus-mode-active #duplicates-container, .focus-mode-active #Bookmarks > h2,
        .focus-mode-active #Bookmarks > #bookmark-controls, .focus-mode-active #Bookmarks > #bookmark-list-container,
        .focus-mode-active #RSSFeeds > h2, .focus-mode-active #RSSFeeds > #rss-feed-controls,
        .focus-mode-active #RSSFeeds > #subscribedFeedsListContainer, .focus-mode-active #backToTopBtn,
        .focus-mode-active #lib-article-tags-container,
        .focus-mode-active #lib-article-original-url,
        .focus-mode-active #library-article-view > div:first-of-type:not(#lib-article-webview-container):not(#library-reading-progress-container),
        .focus-mode-active #autoScrollControls,
        .focus-mode-active .auto-scroll-controls-extractor,
        .focus-mode-active .reading-progress-container:not(#library-reading-progress-container)
         { display: none !important; }
        .focus-mode-active .theme-toggle-container { display: flex !important; }
        .focus-mode-active #focusModeToggleBtn { display: flex !important; }
        .focus-mode-active .main-container { max-width: 100%; margin-top: 5px; padding: 5px; box-shadow: none; border-radius: 0; }
        .focus-mode-active #ae_result .single-story,
        .focus-mode-active #library-article-view { margin: 0 auto; padding: 10px; max-width: 800px; border-bottom: none !important; }
        .focus-mode-active #library-article-view[data-has-content="true"] { display: block !important; }
        .focus-mode-active #ae_result .single-story hr { display:none !important; }
        .focus-mode-active #lib-article-text-content,
        .focus-mode-active #ae_result .article-body-content,
        .focus-mode-active #lib-content-area,
        .focus-mode-active #lib-article-webview-container,
        .focus-mode-active .original-webview-container,
        .focus-mode-active .youtube-video-container
         { max-height: calc(100vh - 120px); border: none; padding: 5px; }
        .focus-mode-active #lib-article-iframe,
        .focus-mode-active .original-webview-iframe { height: calc(100vh - 120px); }
        .focus-mode-active #audioPlayerContainer, .focus-mode-active #youtube-playback-controls, .focus-mode-active #youtube-controls { position: sticky; bottom: 0; background-color: var(--container-bg); border-top: 1px solid var(--border-color); border-radius: 0; padding: 10px; margin-top: 0; }
        .focus-mode-active #audioPlayerContainer .visualizer-container { height: 40px; }

        .duplicate-group { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: var(--bg-color); }
        .duplicate-group h4 { margin-top: 0; color: var(--primary-color); }
        .duplicate-item { padding: 10px; border-bottom: 1px dashed var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .duplicate-item:last-child { border-bottom: none; }
        .duplicate-item label { flex-grow: 1; cursor: pointer; }
        .duplicate-item .item-details { font-size: 0.8em; color: var(--text-color); opacity: 0.8; word-break: break-all; }
        .duplicate-group-actions { margin-top: 10px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
        .duplicate-group-actions button { margin-left: 0 !important; }

        #library-list-container { max-height: 60vh; overflow-y: auto; position: relative; }
        #library-list { position: relative; }
        #library-list .library-item { position: absolute; left: 0; right: 0; box-sizing: border-box; border-bottom: 1px solid var(--border-color); }
        #library-list .library-item:last-child { border-bottom: none; }

        .auto-scroll-controls-extractor { margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .auto-scroll-controls-extractor button { margin-left: 0 !important; margin-top: 0 !important; padding: 6px 10px !important; font-size: 0.9em !important; }
        .auto-scroll-controls-extractor span { font-size: 0.9em; }
        .auto-scroll-controls-extractor .speed-display { margin-left: auto; }

        /* Styles for YouTube Browser tab */
        #youtube-browser-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .youtube-video-card {
            cursor: pointer;
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        .youtube-video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .youtube-video-card img {
            width: 100%;
            border-radius: 8px;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }
        .youtube-video-card h4 {
            margin: 8px 0 5px 0;
            font-size: 1em;
            color: var(--primary-color);
            line-height: 1.3;
            max-height: 2.6em; /* 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .youtube-video-card p {
            font-size: 0.8em;
            margin: 0;
            opacity: 0.8;
            line-height: 1.4;
        }

    </style>
</head>
<body>
    <div id="progress-bar"></div>
    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme('light')" title="लाइट मोड">☀️</button>
        <button class="theme-toggle" onclick="toggleTheme('dark')" title="डार्क मोड">🌓</button>
        <button class="theme-toggle" onclick="toggleTheme('sepia')" title="सेपिया मोड">📜</button>
        <button class="theme-toggle" onclick="toggleTheme('high-contrast')" title="उच्च कंट्रास्ट मोड">👁️‍🗨️</button>
        <button id="focusModeToggleBtn" class="theme-toggle" onclick="toggleFocusMode()" title="फ़ोकस मोड टॉगल करें">🧘</button>
        <button class="theme-toggle" onclick="openSettingsModal()" title="सेटिंग्स">⚙️</button>
    </div>
    <div class="main-container">
        <h1>आर्टिकल रीडर प्रो</h1>
        <div id="googleSearchContainer" style="margin-bottom: 15px; display: flex; gap: 5px;"><input type="search" id="googleSearchQuery" placeholder="गूगल पर खोजें..." style="flex-grow: 1; margin-top:0;"><button onclick="performGoogleSearch()" class="tool-btn" style="margin-top:0; padding: 12px 15px;" title="खोजें">🔍</button></div>
        <div id="internalNavHistoryContainer" style="display: none; justify-content:space-between; margin-bottom:10px;"><button id="historyBackBtn" onclick="navigateHistory(-1)" disabled>⬅️ पिछला</button><button id="historyForwardBtn" onclick="navigateHistory(1)" disabled>➡️ अगला</button></div>
        <div class="tabs">
            <button class="tab-link active" onclick="openTool(event, 'ArticleExtractor')">निकालें</button>
            <button class="tab-link" onclick="openTool(event, 'YouTubeBrowser')">YouTube</button>
            <button class="tab-link" onclick="openTool(event, 'MyLibrary')">मेरी लाइब्रेरी <span id="library-count">(0)</span></button>
            <button class="tab-link" onclick="openTool(event, 'Bookmarks')">बुकमार्क <span id="bookmark-count">(0)</span></button>
            <button class="tab-link" onclick="openTool(event, 'RSSFeeds')">RSS फ़ीड्स <span id="rss-feed-count">(0)</span></button>
            <button class="tab-link" onclick="openTool(event, 'LinkCollector')">लिंक कलेक्टर</button>
        </div>

        <div id="ArticleExtractor" class="tool-content" style="display:block;">
            <p>किसी भी आर्टिकल, YouTube (वीडियो, प्लेलिस्ट, चैनल), या वेबसाइट का लिंक यहाँ डालें।</p>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="url" id="articleUrl" placeholder="https://example.com/" style="flex-grow: 1; margin-top:0;">
                <button id="clearUrlBtn" onclick="clearUrlInput()" title="URL साफ़ करें">✗</button>
            </div>
            <div style="margin-top: 10px; margin-bottom: 5px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                <div><input type="checkbox" id="crawlSiteToggle" name="crawlSiteToggle" checked onchange="toggleDepthSelector()"><label for="crawlSiteToggle" style="font-size: 0.9em; cursor:pointer;">इस URL से जुड़े अन्य आर्टिकल भी खोजें</label></div>
                <div id="depthSelectorContainer" style="display: inline-block;"><label for="crawlDepth" style="font-size: 0.9em;">खोज की गहराई:</label><select id="crawlDepth" name="crawlDepth" style="font-size: 0.9em; padding: 5px;"><option value="0">केवल यह पेज</option><option value="1" selected>1 स्तर गहरा</option><option value="2">2 स्तर गहरा</option><option value="3">3 स्तर गहरा (धीमा)</option></select></div>
            </div>
            <div style="margin-top: 15px; margin-bottom: 5px;">
                <input type="search" id="extractorSearch" placeholder="वर्तमान परिणामों में खोजें..." oninput="filterExtractedArticles()" style="width: calc(100% - 145px); margin-right: 10px; margin-top:0;">
                <button onclick="clearExtractorSearch()" class="tool-btn-secondary" style="padding: 10px 15px; margin-top: 0; font-size:0.9em;">खोज साफ़ करें</button>
            </div>
            <button class="tool-btn" onclick="ae_startExtraction()">निकालें</button>
            <button id="toggleCrawlBtn" class="tool-btn-secondary" onclick="toggleCrawling()" style="display: none;">⏹️ क्रॉलिंग रोकें</button>
            <button class="tool-btn-secondary" onclick="clearResults()">परिणाम साफ़ करें</button>
            <button id="playAllExtractedBtn" class="tool-btn-secondary" onclick="playAllExtractedArticles()" style="display: none; background-color: var(--success-color); margin-left:10px; margin-top:15px;">▶️ सभी प्ले करें</button>
            <div id="ae_loading" style="display:none;"></div>
            <div class="result-box" id="ae_result"></div>
        </div>

        <div id="YouTubeBrowser" class="tool-content" style="display:none;">
            <h2>YouTube ब्राउज़ करें</h2>
            <div id="youtube-browser-controls" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="search" id="youtubeSearchQuery" placeholder="YouTube पर खोजें..." style="flex-grow: 1; margin-top:0;">
                <button onclick="searchYouTube()" class="tool-btn" style="margin-top:0;">खोजें</button>
            </div>
            <div id="youtube-browser-results">
                <!-- YouTube खोज परिणाम यहाँ दिखाए जाएंगे -->
            </div>
        </div>

        <div id="MyLibrary" class="tool-content" style="display:none;">
            <h2>सेव की गई सामग्री</h2>
            <div class="library-controls">
                <input type="search" id="librarySearch" placeholder="टाइटल से खोजें..." oninput="loadLibrary()">
                <select id="librarySort" onchange="loadLibrary()">
                    <option value="date_desc">सबसे नया पहले</option><option value="date_asc">सबसे पुराना पहले</option>
                    <option value="title_asc">टाइटल (A-Z)</option><option value="title_desc">टाइटल (Z-A)</option>
                </select>
                <div id="libraryTagFilterContainer" style="display:inline-block; margin-left:10px;"><label for="libraryTagFilter" style="font-size:0.9em;">टैग फ़िल्टर:</label><select id="libraryTagFilter" onchange="loadLibrary()" style="font-size:0.9em; padding:5px; width:auto; margin-top:0;"><option value="">सभी टैग</option></select></div>
                <div id="libraryReadStatusFilterContainer" style="display:inline-block; margin-left:10px;"><label for="libraryReadStatusFilter" style="font-size:0.9em;">स्थिति फ़िल्टर:</label><select id="libraryReadStatusFilter" onchange="loadLibrary()" style="font-size:0.9em; padding:5px; width:auto; margin-top:0;"><option value="all">सभी</option><option value="read">पढ़ा हुआ</option><option value="unread">अपठित</option></select></div>
                <button id="clearLibraryFiltersBtn" class="tool-btn-secondary" onclick="clearLibraryFilters()" style="margin-top:0; margin-left: 10px; font-size:0.9em; padding:8px 12px; display:none;">फ़िल्टर साफ़ करें</button>
                <button id="findDuplicatesBtn" class="tool-btn-secondary" onclick="findAndDisplayDuplicates()" style="margin-top:0; margin-left: 10px; font-size:0.9em; padding:8px 12px;">डुप्लिकेट खोजें</button>
            </div>
            <div class="library-playlist-controls">
                <button id="playSelectedBtn" onclick="playSelectedLibraryItems()" class="tool-btn-secondary" style="margin-top:10px; margin-left:0; display:none; background-color: var(--success-color);">चयनित चलाएं</button>
                <button id="createSelectedMp3Btn" onclick="createSelectedMp3()" class="tool-btn-secondary" style="margin-top:10px; margin-left:10px; display:none;">चयनित का MP3 बनाएं</button>
                <button id="viewQueueBtn" onclick="openQueueModal()" class="tool-btn-secondary" style="margin-top:10px; margin-left:10px; display:none;">क्यू देखें (<span id="queue-count">0</span>)</button>
                <div style="margin-top:10px; margin-left:10px;"><input type="checkbox" id="autoPlayNextToggle" onchange="handleAutoPlayToggle(this.checked)"><label for="autoPlayNextToggle" style="font-size: 0.9em; cursor:pointer;">अगला ऑटो-प्ले करें</label></div>
            </div>
            <div class="library-controls" style="margin-top:10px;">
                <button onclick="exportLibrary()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; font-size:0.9em; padding:8px 12px;">लाइब्रेरी एक्सपोर्ट करें</button>
                <input type="file" id="importLibraryFile" accept=".json" onchange="importLibraryHandler(event)" style="display:none;">
                <button onclick="document.getElementById('importLibraryFile').click()" class="tool-btn-secondary" style="margin-top:0; font-size:0.9em; padding:8px 12px;">लाइब्रेरी इंपोर्ट करें</button>
            </div>
            <div id="library-content-wrapper" style="margin-top:15px;">
                <div id="library-list-container"><div id="library-list"></div></div>
                 <div id="duplicates-container" style="margin-top: 20px; display:none;">
                    <h3>संभावित डुप्लिकेट</h3>
                    <div id="duplicates-list"></div>
                    <button id="clearDuplicatesViewBtn" class="tool-btn-secondary" onclick="clearDuplicatesView()" style="margin-top:10px; display:none;">डुप्लिकेट व्यू साफ़ करें</button>
                </div>
                <div id="library-article-view" style="display: none;" data-has-content="false">
                    <div id="library-reading-progress-container" class="reading-progress-container">
                        <div id="library-reading-progress-bar" class="reading-progress-bar"></div>
                    </div>
                    <h3 id="lib-article-title"></h3>
                    <p style="margin-top:0; margin-bottom: 5px;"><small>मूल URL: <a id="lib-article-original-url" href="#" target="_blank" rel="noopener noreferrer"></a></small></p>
                    <div style="margin-bottom:15px; margin-top:5px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <button onclick="copyLibraryArticleText()" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; margin-left:0; margin-top:0;">पूरा टेक्स्ट कॉपी करें</button>
                        <button id="shareLibArticleBtn" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; background-color: var(--success-color); margin-top:0;">शेयर करें</button>
                        <button onclick="toggleOriginalWebViewForLibrary()" id="toggleOriginalViewLibBtn" class="tool-btn-secondary original-view-btn" style="padding: 8px 12px; font-size: 0.9em; margin-left:0; margin-top:0;">🌐 वेब व्यू दिखाएं</button>
                        <div style="margin-left:auto;"><label style="font-size:0.9em;">फ़ॉन्ट: </label><button onclick="adjustFontSizeSetting('library', -1)" title="फ़ॉन्ट घटाएं" style="padding:5px 8px; font-size:0.8em;">A-</button><button onclick="adjustFontSizeSetting('library', 1)" title="फ़ॉन्ट बढ़ाएं" style="padding:5px 8px; font-size:0.8em;">A+</button></div>
                    </div>
                    <div id="autoScrollControls" style="margin-top:10px; margin-bottom:10px; padding:10px; border:1px solid var(--border-color); border-radius: 6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <span style="font-weight:bold;">ऑटो-स्क्रॉल:</span>
                        <button id="autoScrollPlayPauseBtnLib" onclick="toggleAutoScroll('library_article', '#lib-article-text-content', '#autoScrollPlayPauseBtnLib', '#autoScrollSpeedDisplayLib')">▶️ शुरू करें</button>
                        <button onclick="changeAutoScrollSpeed('library_article', -20, '#lib-article-text-content', '#autoScrollPlayPauseBtnLib', '#autoScrollSpeedDisplayLib')">धीमा 🐢</button>
                        <button onclick="changeAutoScrollSpeed('library_article', 20, '#lib-article-text-content', '#autoScrollPlayPauseBtnLib', '#autoScrollSpeedDisplayLib')">तेज़ 🐇</button>
                        <span id="autoScrollSpeedDisplayLib" class="speed-display" style="margin-left:auto;">गति: 50</span>
                    </div>
                    <div id="audioPlayerContainer">
                        <div class="visualizer-container"><canvas id="audioVisualizer" width="300" height="60"></canvas></div>
                        <div class="progress-container"><span class="current-time">0:00</span><input type="range" class="progress-bar" value="0" min="0" max="100" step="0.1"><span class="total-time">0:00</span></div>
                        <div class="controls-container"><button class="shuffle-btn" title="शफल">🔀</button><button class="skip-btn prev-btn" title="पिछला">⏮️</button><button class="play-pause-btn" title="प्ले/पॉज़">▶️</button><button class="skip-btn next-btn" title="अगला">⏭️</button><button class="repeat-btn" title="रिपीट">🔁</button></div>
                    </div>
                    <div id="youtube-controls" style="display: none; margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                        <span style="font-weight: bold; color: var(--primary-color);">📺 वीडियो विकल्प:</span>
                        <div id="quality-buttons"></div>
                        <div style="margin-left: auto;">
                            <input type="checkbox" id="audioOnlyToggle" onchange="toggleAudioOnlyMode(this.checked)">
                            <label for="audioOnlyToggle">केवल ऑडियो मोड</label>
                        </div>
                    </div>
                    <div id="youtube-playback-controls" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; justify-content: space-around; align-items: center; gap: 10px;">
                        <button class="tool-btn-secondary" onclick="ytPlayer.seekTo(ytPlayer.getCurrentTime() - 10, true)" style="margin:0; font-size:1.2em;">⏪ 10s</button>
                        <button class="tool-btn-secondary" onclick="playPreviousInQueue()" style="margin:0; font-size:1.5em;">⏮️</button>
                        <button id="youtube-play-pause-btn" class="tool-btn" onclick="toggleYoutubePlayback()" style="margin:0; font-size:1.5em; width: 60px; height: 60px; border-radius: 50%;">▶️</button>
                        <button class="tool-btn-secondary" onclick="playNextInQueueOrAutoplay()" style="margin:0; font-size:1.5em;">⏭️</button>
                        <button class="tool-btn-secondary" onclick="ytPlayer.seekTo(ytPlayer.getCurrentTime() + 10, true)" style="margin:0; font-size:1.2em;">10s ⏩</button>
                    </div>
                    <div id="sleep-timer-controls" style="margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                        <label for="sleepTimerSelect" style="font-weight: bold; color: var(--primary-color);">⏲️ स्लीप टाइमर:</label>
                        <select id="sleepTimerSelect" onchange="setSleepTimer(this.value)" style="padding: 5px 8px; font-size: 0.9em; background-color: var(--bg-color); color: var(--text-color); border:1px solid var(--border-color); border-radius:4px; cursor:pointer; margin-top:0;">
                            <option value="0">बंद</option><option value="5">5 मिनट</option><option value="15">15 मिनट</option>
                            <option value="30">30 मिनट</option><option value="60">60 मिनट</option><option value="-1">इस आइटम के अंत में</option>
                        </select>
                        <button id="cancelSleepTimerBtn" onclick="cancelSleepTimer()" style="display: none; background-color: var(--danger-color); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-top:0;">रद्द करें</button>
                        <span id="sleepTimerDisplay" style="margin-left: auto; font-size: 0.9em; font-style: italic;"></span>
                    </div>

                    <div id="lib-content-area" style="margin-top: 15px;">
                        <!-- Content for articles, videos, etc. will be injected here -->
                    </div>

                    <div id="lib-article-tags-container" style="margin-top: 15px;">
                        <h4>टैग्स:</h4><div id="lib-article-current-tags" style="margin-bottom:10px;"></div>
                        <div style="display: flex; gap: 5px; align-items:center;">
                            <input type="text" id="lib-new-tag-input" placeholder="नया टैग जोड़ें" style="flex-grow:1; margin-top:0; font-size:0.9em; padding:8px;">
                            <button onclick="addTagToCurrentLibraryArticle()" class="tool-btn-secondary" style="margin-top:0;padding: 8px 12px; font-size: 0.9em;">टैग जोड़ें</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="Bookmarks" class="tool-content" style="display:none;">
            <h2>बुकमार्क</h2>
            <div id="bookmark-controls">
                <input type="text" id="bookmarkName" placeholder="नाम (वैकल्पिक)" style="flex:1;">
                <input type="url" id="bookmarkUrl" placeholder="https://example.com/" required style="flex:2;">
                <select id="bookmarkAssignFolder" title="फ़ोल्डर चुनें" style="flex:1;"></select>
                <button class="tool-btn" onclick="addBookmark()" style="padding:10px 15px; font-size:0.9em; margin-top:0;">बुकमार्क जोड़ें</button>
            </div>
             <div id="bookmark-controls" style="margin-top:5px;">
                <input type="text" id="newBookmarkFolderName" placeholder="नया फ़ोल्डर नाम" style="flex:1;">
                <button class="tool-btn-secondary" onclick="createBookmarkFolder()" style="padding:10px 15px; font-size:0.9em; margin-left:0; margin-top:0;">फ़ोल्डर बनाएँ</button>
                <select id="bookmarkFolderFilter" onchange="loadBookmarks()" title="फ़ोल्डर द्वारा फ़िल्टर करें" style="flex:1; margin-left:auto;"></select>
            </div>
            <div id="bookmark-list-container">
                <div id="bookmark-list"></div>
            </div>
        </div>

        <div id="RSSFeeds" class="tool-content" style="display:none;">
            <h2>RSS फ़ीड्स</h2>
            <div id="rss-feed-controls">
                <input type="url" id="rssFeedUrlInput" placeholder="वेबसाइट URL या RSS/पॉडकास्ट फ़ीड URL डालें">
                <button class="tool-btn" onclick="addRssFeed()">फ़ीड जोड़ें</button>
                <button id="refreshAllRssFeedsBtn" class="tool-btn-secondary" onclick="refreshAllRssFeeds()" style="margin-left:10px;">🔄 सभी रिफ्रेश करें</button>
            </div>
            <div id="subscribedFeedsListContainer" style="margin-top:15px;">
                 <div id="subscribedFeedsList"></div>
            </div>
            <div id="rssArticlesContainer" style="margin-top:15px;">
                <h3 id="rssFeedTitleDisplay"></h3>
                <div id="rssArticlesList"></div>
            </div>
        </div>

        <div id="LinkCollector" class="tool-content" style="display:none;">
            <h2>लिंक कलेक्टर</h2>
            <p>यहां टेक्स्ट पेस्ट करें जिसमें से लिंक निकालने हैं। यह टूल टेक्स्ट में से सभी URL को निकाल कर सूची बना देगा।</p>
            <textarea id="textWithLinks" rows="10" placeholder="यहाँ टेक्स्ट पेस्ट करें..."></textarea>
            <button class="tool-btn" onclick="collectLinksFromText()">लिंक निकालें</button>
            <button class="tool-btn-secondary" onclick="copyAllCollectedLinks()" style="display:none;" id="copyAllLinksBtn">सभी लिंक कॉपी करें</button>
            <button class="tool-btn-secondary danger-btn" onclick="clearCollectedLinks()" style="display:none;" id="clearAllLinksBtn">साफ़ करें</button>
            <div id="collectedLinksContainer" style="margin-top: 20px;"></div>
        </div>
    </div>
    <button id="backToTopBtn" onclick="scrollToTop()" title="ऊपर जाएं">⬆️</button>
    <div id="toast-container"></div>

    <div id="queueModal" class="queue-modal-overlay">
        <div class="queue-modal-content">
            <div class="queue-modal-header"><h3>प्लेबैक क्यू</h3><button class="settings-close-btn" onclick="closeQueueModal()">×</button></div>
            <ul id="queue-list"></ul>
            <div class="queue-modal-footer" style="text-align:right; margin-top:15px; border-top: 1px solid var(--border-color); padding-top:15px;">
                <button class="tool-btn-secondary danger-btn" style="margin-left:0; margin-top:0;" onclick="clearQueue()">क्यू साफ़ करें</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal-overlay">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h2>सेटिंग्स</h2>
                <button class="settings-close-btn" onclick="closeSettingsModal()">×</button>
            </div>
            <div class="settings-modal-body">
                <fieldset>
                    <legend>थीम</legend>
                    <div class="setting-item">
                        <label>रंग योजना चुनें:</label>
                        <div class="setting-control">
                            <input type="radio" id="theme_light" name="theme_setting" value="light"><label for="theme_light">☀️ लाइट</label>
                            <input type="radio" id="theme_dark" name="theme_setting" value="dark"><label for="theme_dark">🌓 डार्क</label>
                            <input type="radio" id="theme_sepia" name="theme_setting" value="sepia"><label for="theme_sepia">📜 सेपिया</label>
                            <input type="radio" id="theme_high_contrast" name="theme_setting" value="high-contrast"><label for="theme_high_contrast">👁️‍🗨️ उच्च कंट्रास्ट</label>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>पठन फ़ॉन्ट</legend>
                    <div class="setting-item">
                        <label for="fontFamilySetting">फ़ॉन्ट चुनें:</label>
                        <div class="setting-control">
                            <select id="fontFamilySetting" style="margin-top:0; min-width: 200px;">
                                <option value='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'>डिफ़ॉल्ट सिस्टम</option>
                                <option value='"Merriweather", serif'>Merriweather (सेरिफ़)</option>
                                <option value='"Lora", serif'>Lora (सेरिफ़)</option>
                                <option value='"Open Sans", sans-serif'>Open Sans (सैन्स-सेरिफ़)</option>
                                <option value='"Roboto", sans-serif'>Roboto (सैन्स-सेरिफ़)</option>
                                <option value='"Noto Sans", sans-serif'>Noto Sans (सैन्स-सेरिफ़ - हिंदी के लिए अच्छा)</option>
                                <option value='"Noto Serif", serif'>Noto Serif (सेरिफ़ - हिंदी के लिए अच्छा)</option>
                                <option value='"Lexend Deca", sans-serif'>Lexend Deca (पढ़ने में आसान)</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>आर्टिकल डिस्प्ले</legend>
                    <div class="setting-item">
                        <label for="displayModeSetting">कंटेंट डिस्प्ले मोड:</label>
                        <div class="setting-control">
                            <select id="displayModeSetting" style="margin-top:0;">
                                <option value="image-text">इमेज और टेक्स्ट</option>
                                <option value="text-only">केवल टेक्स्ट</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>टेक्स्ट आकार</legend>
                    <div class="setting-item">
                        <label for="extractorFontSizeSetting">एक्सट्रैक्टर फ़ॉन्ट आकार:</label>
                        <div class="setting-control range-control">
                            <button onclick="adjustFontSizeSetting('extractor', -1)" class="tool-btn-secondary" style="margin:0; padding: 6px 10px; font-size:0.9em;">A-</button>
                            <span id="extractorFontSizeDisplay" style="min-width:40px; text-align:center;">16px</span>
                            <button onclick="adjustFontSizeSetting('extractor', 1)" class="tool-btn-secondary" style="margin:0; padding: 6px 10px; font-size:0.9em;">A+</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="libraryFontSizeSetting">लाइब्रेरी फ़ॉन्ट आकार:</label>
                        <div class="setting-control range-control">
                             <button onclick="adjustFontSizeSetting('library', -1)" class="tool-btn-secondary" style="margin:0; padding: 6px 10px; font-size:0.9em;">A-</button>
                            <span id="libraryFontSizeDisplay" style="min-width:40px; text-align:center;">16px</span>
                            <button onclick="adjustFontSizeSetting('library', 1)" class="tool-btn-secondary" style="margin:0; padding: 6px 10px; font-size:0.9em;">A+</button>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>ऑडियो सेटिंग्स</legend>
                    <div class="setting-item">
                        <label for="ttsMethodSetting">TTS इंजन:</label>
                        <div class="setting-control">
                             <select id="ttsMethodSetting" style="margin-top:0;">
                                <option value="stream">Google स्ट्रीम (अनुशंसित)</option>
                                <option value="local">डिवाइस TTS</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="ttsRateSetting">बोलने/प्लेबैक की गति:</label>
                        <div class="setting-control range-control">
                            <input type="range" id="ttsRateSetting" min="0.5" max="2" step="0.1" value="1" style="margin-top:0;">
                            <span id="ttsRateDisplaySetting">1.0x</span>
                        </div>
                    </div>
                    <div class="setting-item" id="voiceSelectorContainerSetting" style="display:none;">
                        <label for="voiceSelectorSetting">आवाज़ (डिवाइस TTS):</label>
                        <div class="setting-control">
                            <select id="voiceSelectorSetting" style="margin-top:0;"></select>
                        </div>
                    </div>
                     <div class="setting-item" id="libVoiceSelectorContainer" style="display:none;">
                        <label for="libVoiceSelector">आवाज़ (डिवाइस TTS):</label>
                        <div class="setting-control">
                            <select id="libVoiceSelector" onchange="setTTSVoice(this.value)" style="margin-top:0;"></select>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>पढ़ने के आँकड़े</legend>
                    <div class="setting-item">
                        <label for="statsTrackingToggle">आँकड़ों की ट्रैकिंग सक्षम करें:</label>
                        <div class="setting-control">
                            <input type="checkbox" id="statsTrackingToggle" onchange="toggleStatsTracking(this.checked)">
                        </div>
                    </div>
                    <div id="statsDisplayArea" style="margin-top: 15px; font-size: 0.9em; display:none;">
                        <h4>आपके आँकड़े:</h4>
                        <p>कुल पढ़े गए आइटम: <strong id="statsTotalRead">0</strong></p>
                        <p>कुल अनुमानित पढ़ने का समय: <strong id="statsTotalTime">0</strong> मिनट</p>
                        <div id="statsSourceCounts">
                            <p><strong>शीर्ष स्रोत:</strong></p>
                            <ul id="statsSourceList" style="list-style-position: inside; padding-left:10px;"></ul>
                        </div>
                        <button class="tool-btn-secondary danger-btn" onclick="resetReadingStats()" style="margin-top:10px; font-size:0.8em; padding:6px 10px;">आँकड़े रीसेट करें</button>
                    </div>
                </fieldset>
                <fieldset class="danger-zone">
                    <legend>डेटा प्रबंधन</legend>
                    <div class="setting-item">
                        <label>लाइब्रेरी डेटा:</label>
                        <div class="setting-control">
                            <button class="tool-btn-secondary" onclick="exportLibrary()" style="background-color:var(--secondary-color); margin-top:0;">एक्सपोर्ट</button>
                            <button class="tool-btn-secondary" onclick="document.getElementById('importLibraryFile').click()" style="background-color:var(--secondary-color); margin-top:0;">इंपोर्ट</button>
                            <button class="danger-btn" onclick="clearLibraryData()" style="margin-top:0;">लाइब्रेरी साफ़ करें</button>
                        </div>
                    </div>
                     <div class="setting-item">
                        <label>बुकमार्क डेटा:</label>
                        <div class="setting-control">
                            <button class="danger-btn" onclick="clearBookmarksData()" style="margin-top:0;">बुकमार्क साफ़ करें</button>
                        </div>
                    </div>
                     <div class="setting-item">
                        <label>RSS फ़ीड डेटा:</label>
                        <div class="setting-control">
                            <button class="danger-btn" onclick="clearRssFeedsData()" style="margin-top:0;">RSS फ़ीड्स साफ़ करें</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label>सभी सेटिंग्स और डेटा:</label>
                        <div class="setting-control">
                            <button class="danger-btn" onclick="resetAllSettings()" style="margin-top:0;">सब रीसेट करें</button>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="settings-modal-footer">
                <button class="tool-btn" onclick="closeSettingsModal()" style="background-color:var(--success-color); margin-top:0;">सहेजें और बंद करें</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- ALL JAVASCRIPT CODE ---
        const createServiceWorkerCode = (proxyHost) => `self.addEventListener('install',e=>e.waitUntil(self.skipWaiting()));self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{if(e.request.url.includes('${proxyHost}')){e.respondWith(fetch(e.request,{cache:'no-store'}))}});`;
        const MY_PRIVATE_PROXY = 'https://article-proxyy.rockysmail69.workers.dev';

        let allFoundLinks = new Set();
        let currentProcessIndex = 0;
        let isProcessing = false;
        const speechApiSupported = 'speechSynthesis' in window;
        const mediaSessionSupported = ('mediaSession' in navigator);
        let localSpeechSynth;
        let audioQueue = [];
        let preloadedAudioBlobs = {};
        let currentlyPlayingChunkIndex = -1;
        let allTextChunksForStream = [];
        const PRELOAD_AHEAD_COUNT = 2;
        let currentAudioElement = null, currentStreamController = null;
        let localTtsQueue = [];
        let isPlaying = false;
        let isPaused = false;
        let wasSpeakingBeforeTabSwitch = false;
        let navigationHistory = [], currentHistoryIndex = -1, isNavigatingHistory = false;
        let currentDisplayMode = 'image-text';
        let isCrawlingPaused = false;
        let sleepTimerId = null, sleepTimerIntervalId = null, sleepTimerEndTime = 0, stopAtArticleEnd = false;
        let playQueue = [];
        let currentQueueIndex = -1;
        let currentArticleTotalChunks = 0;
        let visualizerContext = { audioCtx: null, analyser: null, source: null, animationFrameId: null, dataArray: null, bufferLength: 0, canvas: null, canvasCtx: null };
        let audioPlayerState = { isShuffle: false, repeatMode: 'off', unshuffledQueue: [], currentItem: null };
        let ytPlayer = null; 

        const STORAGE_KEY_THEME = 'articleReaderTheme_s1';
        const STORAGE_KEY_LIBRARY = 'articleReaderLibrary_s11_pro_final';
        const STORAGE_KEY_FONT_SIZE = 'articleReaderFontSize_s1';
        const STORAGE_KEY_LIBRARY_FONT_SIZE = 'articleReaderLibraryFontSize_s1';
        const STORAGE_KEY_FONT_FAMILY = 'articleReaderFontFamily_v1';
        const STORAGE_KEY_TTS_METHOD = 'articleReaderTTSMethod_v1';
        const STORAGE_KEY_TTS_RATE = 'articleReaderTTSRate_v2';
        const STORAGE_KEY_TTS_VOICE = 'articleReaderTTSVoice_v1';
        const STORAGE_KEY_DISPLAY_MODE = 'articleReaderDisplayMode_s1';
        const STORAGE_KEY_BOOKMARKS = 'articleReaderBookmarks_s3';
        const STORAGE_KEY_AUTOPLAY = 'articleReaderAutoplay_v1';
        const STORAGE_KEY_PLAYBACK_POSITIONS = 'articleReaderPlaybackPositions_v3_media';
        const STORAGE_KEY_PLAY_QUEUE = 'articleReaderPlayQueue_v3_media';
        const STORAGE_KEY_RSS_FEEDS = 'articleReaderRssFeeds_v3_media';
        const STORAGE_KEY_SCROLL_POSITIONS = 'articleReaderScrollPositions_v1';
        const STORAGE_KEY_FOCUS_MODE = 'articleReaderFocusMode_v1';
        const STORAGE_KEY_RSS_READ_ITEMS = 'articleReaderRssReadItems_v1';
        const STORAGE_KEY_STATS = 'articleReaderStats_v1';

        let scrollSaveTimeout = null;
        const MIN_SCROLL_SPEED = 10;
        const MAX_SCROLL_SPEED = 200;
        let autoScrollStates = {};

        const VIRTUAL_SCROLL_ITEM_HEIGHT_ESTIMATE = 60;
        const VIRTUAL_SCROLL_OVERSCAN = 5;
        let libraryVirtualScrollState = { items: [], startIndex: 0, endIndex: 0, scrollTop: 0, itemHeight: VIRTUAL_SCROLL_ITEM_HEIGHT_ESTIMATE, listContainerElement: null, listElement: null, totalHeight: 0, visibleItemCount: 0, isInitialized: false, scrollHandlerAttached: false };
        let detectedDuplicateGroups = [];
        
        // --- YOUTUBE BROWSER FUNCTIONS ---
        async function searchYouTube() {
            const query = document.getElementById('youtubeSearchQuery').value.trim();
            if (!query) return;
            
            const resultsContainer = document.getElementById('youtube-browser-results');
            resultsContainer.innerHTML = '<p style="text-align:center; padding: 20px;">खोज हो रही है...</p>';

            try {
                const response = await fetch(`${MY_PRIVATE_PROXY}/yt-search?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'खोज विफल हुई। प्रॉक्सी सर्वर से जवाब नहीं मिला।'}));
                    throw new Error(errorData.error);
                }
                const data = await response.json();
                displayYouTubeResults(data.items);
            } catch (error) {
                resultsContainer.innerHTML = `<p style="text-align:center; padding: 20px;">खोज में त्रुटि: ${error.message}</p>`;
                showToast(error.message, 'error');
            }
        }

        async function loadTrendingYouTubeVideos() {
            const resultsContainer = document.getElementById('youtube-browser-results');
            resultsContainer.innerHTML = '<p style="text-align:center; padding: 20px;">ट्रेंडिंग वीडियो लोड हो रहे हैं...</p>';

            try {
                const response = await fetch(`${MY_PRIVATE_PROXY}/yt-trending`);
                 if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'ट्रेंडिंग वीडियो लोड नहीं हो सके।'}));
                    throw new Error(errorData.error);
                }
                const data = await response.json();
                displayYouTubeResults(data.items);
            } catch (error) {
                resultsContainer.innerHTML = `<p style="text-align:center; padding: 20px;">वीडियो लोड करने में त्रुटि: ${error.message}</p>`;
                showToast(error.message, 'error');
            }
        }

        function displayYouTubeResults(videos) {
            const container = document.getElementById('youtube-browser-results');
            container.innerHTML = '';
            if (!videos || videos.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">कोई परिणाम नहीं मिला।</p>';
                return;
            }

            videos.forEach(video => {
                if(!video || !video.videoId || !video.thumbnail) return;
                const videoCard = document.createElement('div');
                videoCard.className = 'youtube-video-card';
                videoCard.onclick = () => handleYouTubeItemClick(video.videoId);
                
                videoCard.innerHTML = `
                    <img src="${video.thumbnail}" loading="lazy" alt="${video.title}">
                    <h4>${video.title || 'N/A'}</h4>
                    <p>
                        ${video.channelName || ''}<br>
                        ${video.viewCountText || ''} ${video.viewCountText && video.publishedText ? '•' : ''} ${video.publishedText || ''}
                    </p>
                `;
                container.appendChild(videoCard);
            });
        }
        
        function handleYouTubeItemClick(videoId) {
            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
            document.getElementById('articleUrl').value = videoUrl;
            
            const extractorTabButton = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
            openTool({ currentTarget: extractorTabButton }, 'ArticleExtractor');

            ae_startExtraction(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- LINK COLLECTOR FUNCTIONS ---
        function collectLinksFromText() {
            const text = document.getElementById('textWithLinks').value;
            const container = document.getElementById('collectedLinksContainer');
            const copyBtn = document.getElementById('copyAllLinksBtn');
            const clearBtn = document.getElementById('clearAllLinksBtn');
            container.innerHTML = '';

            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const foundUrls = text.match(urlRegex);

            if (!foundUrls || foundUrls.length === 0) {
                container.innerHTML = '<p>कोई लिंक नहीं मिला।</p>';
                copyBtn.style.display = 'none';
                clearBtn.style.display = 'none';
                return;
            }

            const uniqueUrls = [...new Set(foundUrls)];

            uniqueUrls.forEach(url => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'link-list-item';
                itemDiv.innerHTML = `
                    <span class="link-title" title="${url}">${url}</span>
                    <div class="link-actions">
                        <button onclick="openLinkInExtractor('${url}')">रीडर में खोलें</button>
                        <button onclick="window.open('${url}', '_blank')">नई टैब में खोलें</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            copyBtn.style.display = 'inline-block';
            clearBtn.style.display = 'inline-block';
            showToast(`${uniqueUrls.length} अद्वितीय लिंक मिले।`, 'success');
        }

        function openLinkInExtractor(url) {
            document.getElementById('articleUrl').value = url;
            const extractorTabButton = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
            openTool({ currentTarget: extractorTabButton }, 'ArticleExtractor');
            ae_startExtraction(true);
        }

        function copyAllCollectedLinks() {
            const links = Array.from(document.querySelectorAll('#collectedLinksContainer .link-title')).map(span => span.textContent);
            if (links.length > 0) {
                const textToCopy = links.join('\n');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('सभी लिंक क्लिपबोर्ड पर कॉपी किए गए!', 'success');
                }).catch(err => {
                    showToast('लिंक कॉपी करने में विफल: ' + err, 'error');
                });
            }
        }

        function clearCollectedLinks() {
            document.getElementById('textWithLinks').value = '';
            document.getElementById('collectedLinksContainer').innerHTML = '';
            document.getElementById('copyAllLinksBtn').style.display = 'none';
            document.getElementById('clearAllLinksBtn').style.display = 'none';
            showToast('परिणाम साफ़ किए गए।', 'info');
        }


        // --- MAIN APPLICATION FUNCTIONS ---
        function getScrollPositions() { return JSON.parse(localStorage.getItem(STORAGE_KEY_SCROLL_POSITIONS) || '{}'); }
        function saveScrollPosition(itemUrl, scrollPercent) { if (!itemUrl) return; const positions = getScrollPositions(); const itemId = btoa(encodeURIComponent(itemUrl)); positions[itemId] = scrollPercent; localStorage.setItem(STORAGE_KEY_SCROLL_POSITIONS, JSON.stringify(positions));}
        function getSavedScrollPosition(itemUrl) { if (!itemUrl) return null; const positions = getScrollPositions(); const itemId = btoa(encodeURIComponent(itemUrl)); return positions[itemId] || null;}
        function savePlaybackPosition(itemUrl, type, position) { if (!itemUrl) return; const positions = JSON.parse(localStorage.getItem(STORAGE_KEY_PLAYBACK_POSITIONS) || '{}'); const itemId = btoa(encodeURIComponent(itemUrl)); positions[itemId] = { type, position, timestamp: new Date().getTime() }; localStorage.setItem(STORAGE_KEY_PLAYBACK_POSITIONS, JSON.stringify(positions)); }
        function getPlaybackPosition(itemUrl) { if (!itemUrl) return null; const positions = JSON.parse(localStorage.getItem(STORAGE_KEY_PLAYBACK_POSITIONS) || '{}'); const itemId = btoa(encodeURIComponent(itemUrl)); if (positions[itemId] && (new Date().getTime() - 30 * 24 * 60 * 60 * 1000) > positions[itemId].timestamp) { delete positions[itemId]; localStorage.setItem(STORAGE_KEY_PLAYBACK_POSITIONS, JSON.stringify(positions)); return null; } return positions[itemId] || null; }
        function clearPlaybackPosition(itemUrl) { if (!itemUrl) return; const positions = JSON.parse(localStorage.getItem(STORAGE_KEY_PLAYBACK_POSITIONS) || '{}'); const itemId = btoa(encodeURIComponent(itemUrl)); if (positions[itemId]) { delete positions[itemId]; localStorage.setItem(STORAGE_KEY_PLAYBACK_POSITIONS, JSON.stringify(positions)); } }
        function saveQueue() { const queueToSave = { items: playQueue, currentIndex: currentQueueIndex, isShuffle: audioPlayerState.isShuffle, repeatMode: audioPlayerState.repeatMode, unshuffledQueue: audioPlayerState.unshuffledQueue }; localStorage.setItem(STORAGE_KEY_PLAY_QUEUE, JSON.stringify(queueToSave)); }
        function loadQueue() { const savedQueue = JSON.parse(localStorage.getItem(STORAGE_KEY_PLAY_QUEUE) || 'null'); if (savedQueue && Array.isArray(savedQueue.items)) { playQueue = savedQueue.items; currentQueueIndex = savedQueue.currentIndex; audioPlayerState.isShuffle = savedQueue.isShuffle || false; audioPlayerState.repeatMode = savedQueue.repeatMode || 'off'; audioPlayerState.unshuffledQueue = savedQueue.unshuffledQueue || []; updateQueueDisplay(); } }
        function setupVisualizer(audioElement) { if (!visualizerContext.audioCtx) { try { visualizerContext.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.warn("AudioContext not supported, visualizer disabled."); return; } } if(visualizerContext.audioCtx.state === 'suspended') { visualizerContext.audioCtx.resume(); } if (visualizerContext.source) { visualizerContext.source.disconnect(); } visualizerContext.canvas = document.getElementById('audioVisualizer'); if(!visualizerContext.canvas) return; visualizerContext.canvasCtx = visualizerContext.canvas.getContext('2d'); try { visualizerContext.source = visualizerContext.audioCtx.createMediaElementSource(audioElement); visualizerContext.analyser = visualizerContext.audioCtx.createAnalyser(); visualizerContext.analyser.fftSize = 256; visualizerContext.bufferLength = visualizerContext.analyser.frequencyBinCount; visualizerContext.dataArray = new Uint8Array(visualizerContext.bufferLength); visualizerContext.source.connect(visualizerContext.analyser); visualizerContext.analyser.connect(visualizerContext.audioCtx.destination); drawVisualization(); } catch (e) { console.error("Error setting up visualizer:", e); if (e.name === "InvalidStateError" && audioElement.readyState === 0) { console.warn("Visualizer setup failed, retrying on canplay."); audioElement.addEventListener('canplay', () => setupVisualizer(audioElement), {once: true}); } } }
        function drawVisualization() { if (!visualizerContext.analyser) return; visualizerContext.animationFrameId = requestAnimationFrame(drawVisualization); visualizerContext.analyser.getByteFrequencyData(visualizerContext.dataArray); const { canvas, canvasCtx, bufferLength, dataArray } = visualizerContext; canvasCtx.clearRect(0, 0, canvas.width, canvas.height); const barWidth = (canvas.width / bufferLength) * 2.5; let barHeight; let x = 0; const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--player-red').trim(); for (let i = 0; i < bufferLength; i++) { barHeight = dataArray[i] / 2; canvasCtx.fillStyle = themeColor; canvasCtx.fillRect(x, (canvas.height - barHeight) / 2, barWidth, barHeight); x += barWidth + 1; } }
        function stopVisualization() { if (visualizerContext.animationFrameId) { cancelAnimationFrame(visualizerContext.animationFrameId); visualizerContext.animationFrameId = null; } const canvas = document.getElementById('audioVisualizer'); if (canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); } if (visualizerContext.source) { visualizerContext.source.disconnect(); visualizerContext.source = null; } if (visualizerContext.analyser) { visualizerContext.analyser.disconnect(); visualizerContext.analyser = null;} }
        function openQueueModal() { updateQueueDisplay(); document.getElementById('queueModal').classList.add('show'); }
        function closeQueueModal() { document.getElementById('queueModal').classList.remove('show'); }
        function addToQueue(itemData, playNext = false, showToastNotification = true) { if (!itemData || !itemData.url) { if (showToastNotification) showToast("क्यू में जोड़ने के लिए अमान्य डेटा।", "error"); return; } if (playQueue.find(item => item.url === itemData.url)) { if (showToastNotification) showToast("यह आइटम पहले से ही क्यू में है।", "warning"); return; } if (!itemData.title) itemData.title = "अज्ञात शीर्षक"; if (playNext) { playQueue.splice(currentQueueIndex + 1, 0, itemData); if (showToastNotification) showToast(`'${itemData.title.substring(0, 20)}...' अगला बजेगा।`, 'success'); } else { playQueue.push(itemData); if (showToastNotification) showToast(`'${itemData.title.substring(0, 20)}...' क्यू में जोड़ा गया।`, 'success'); } if (!isPlaying && !isPaused && playQueue.length > 0 && playQueue.length === (playNext ? currentQueueIndex + 2 : playQueue.length)) { startQueuePlayback(); } updateQueueDisplay(); saveQueue(); }
        function removeFromQueue(index) { if (index > -1 && index < playQueue.length) { const wasCurrentlyPlayingItem = (index === currentQueueIndex); playQueue.splice(index, 1); if (index < currentQueueIndex) { currentQueueIndex--; } else if (index === currentQueueIndex && playQueue.length === 0) { currentQueueIndex = -1; } else if (index === currentQueueIndex && index >= playQueue.length) { currentQueueIndex = playQueue.length > 0 ? playQueue.length -1 : -1; } updateQueueDisplay(); saveQueue(); if (wasCurrentlyPlayingItem) { stopPlayback(); if(playQueue.length > 0 && currentQueueIndex !== -1 && currentQueueIndex < playQueue.length) { playNextInQueueOrAutoplay(true); } else if (playQueue.length > 0) { playQueueItem(0); } else { hideAudioPlayer(); audioPlayerState.currentItem = null; } } } }
        function clearQueue() { playQueue = []; currentQueueIndex = -1; stopPlayback(); updateQueueDisplay(); saveQueue(); showToast("क्यू साफ़ कर दिया गया है।", "info"); hideAudioPlayer(); audioPlayerState.currentItem = null;}
        function updateQueueDisplay() { const queueList = document.getElementById('queue-list'); const queueCount = document.getElementById('queue-count'); const viewQueueBtn = document.getElementById('viewQueueBtn'); queueList.innerHTML = ''; if (playQueue.length === 0) { queueList.innerHTML = '<li><p style="text-align:center; padding: 20px 0; font-style:italic;">क्यू खाली है।</p></li>'; if (viewQueueBtn) viewQueueBtn.style.display = 'none'; } else { if (viewQueueBtn) { viewQueueBtn.style.display = 'inline-block'; queueCount.textContent = playQueue.length; } playQueue.forEach((item, index) => { const li = document.createElement('li'); li.className = 'queue-item'; if (index === currentQueueIndex && (isPlaying || isPaused)) li.classList.add('playing'); li.dataset.index = index; li.draggable = true; const icon = item.type === 'podcast' ? '🎧' : (item.type === 'youtube' ? '📺' : '📄'); li.innerHTML = ` <span style="cursor: move;" title="क्रम बदलें">⠿</span> <span title="${item.type}">${icon}</span> <span class="queue-item-title" title="प्ले करें: ${item.title}" onclick="handleQueueItemClick(${index})">${item.title}</span> <button class="delete-btn" title="क्यू से हटाएं" onclick="removeFromQueue(${index})">✗</button> `; queueList.appendChild(li); }); addQueueDragDropListeners(); } }
        function addQueueDragDropListeners() { const items = document.querySelectorAll('#queue-list .queue-item'); let dragStartIndex; items.forEach(item => { item.addEventListener('dragstart', e => { dragStartIndex = parseInt(e.currentTarget.dataset.index); e.currentTarget.classList.add('dragging'); }); item.addEventListener('dragend', e => e.currentTarget.classList.remove('dragging')); item.addEventListener('dragover', e => e.preventDefault()); item.addEventListener('drop', e => { e.preventDefault(); const dragEndIndex = parseInt(e.currentTarget.dataset.index); const [reorderedItem] = playQueue.splice(dragStartIndex, 1); playQueue.splice(dragEndIndex, 0, reorderedItem); if (dragStartIndex === currentQueueIndex) currentQueueIndex = dragEndIndex; else if (dragStartIndex < currentQueueIndex && dragEndIndex >= currentQueueIndex) currentQueueIndex--; else if (dragStartIndex > currentQueueIndex && dragEndIndex <= currentQueueIndex) currentQueueIndex++; updateQueueDisplay(); saveQueue(); }); }); }
        function startQueuePlayback() { if (playQueue.length > 0) { const indexToPlay = currentQueueIndex !== -1 && currentQueueIndex < playQueue.length ? currentQueueIndex : 0; if (indexToPlay < playQueue.length) { playQueueItem(indexToPlay); } else if (playQueue.length > 0) { playQueueItem(0); } } }
        async function handleQueueItemClick(index) { if (index >= 0 && index < playQueue.length) { if (index === currentQueueIndex && (isPlaying || isPaused)) { handlePlayPause(); return; } await playQueueItem(index); closeQueueModal(); } else { console.error("Invalid index for queue item click:", index); } }
        async function playQueueItem(index) { if (index >= 0 && index < playQueue.length) { currentQueueIndex = index; saveQueue(); const itemData = playQueue[index]; await createAudioPlayer(itemData); updateQueueDisplay(); } else { if (audioPlayerState.repeatMode === 'all' && playQueue.length > 0) { await playQueueItem(0); } else { currentQueueIndex = -1; saveQueue(); if (isPlaying || isPaused) { showToast("प्लेबैक क्यू समाप्त।", "info"); } stopPlayback(); updateQueueDisplay(); hideAudioPlayer(); audioPlayerState.currentItem = null; } } }
        async function createAudioPlayer(itemData) { await showSavedArticle(itemData); if (!audioPlayerState.currentItem || itemData.url !== audioPlayerState.currentItem.url || (!isPlaying && !isPaused)) { startPlayback(itemData); } else { audioPlayerState.currentItem = itemData; } }
        function hideAudioPlayer() { document.getElementById('audioPlayerContainer').style.display = 'none'; stopVisualization(); }
        function handlePlayPause() { if (!audioPlayerState.currentItem) { if (playQueue.length > 0) { const indexToPlay = currentQueueIndex >= 0 && currentQueueIndex < playQueue.length ? currentQueueIndex : 0; if (indexToPlay < playQueue.length) playQueueItem(indexToPlay); else showToast("चलाने के लिए कोई आइटम नहीं है।", "warning"); } else { showToast("चलाने के लिए कोई आइटम नहीं है।", "warning"); } return; } if(audioPlayerState.currentItem.type === 'youtube') { toggleYoutubePlayback(); return; } if (isPlaying) { pausePlayback(); } else if (isPaused) { resumePlayback(); } else { startPlayback(audioPlayerState.currentItem); } }
        function updatePlayerUI() { const playerContainer = document.getElementById('audioPlayerContainer'); if (!playerContainer) return; const playPauseBtn = playerContainer.querySelector('.play-pause-btn'); let showPauseIcon = isPlaying && audioPlayerState.currentItem && audioPlayerState.currentItem.type !== 'youtube'; playPauseBtn.innerHTML = showPauseIcon ? '⏸️' : '▶️'; const shuffleBtn = playerContainer.querySelector('.shuffle-btn'); shuffleBtn.classList.toggle('active', audioPlayerState.isShuffle); const repeatBtn = playerContainer.querySelector('.repeat-btn'); repeatBtn.classList.toggle('active', audioPlayerState.repeatMode !== 'off'); if (audioPlayerState.repeatMode === 'one') { repeatBtn.innerHTML = '🔁<sub style="font-size: 0.5em; vertical-align: top;">1</sub>'; } else { repeatBtn.innerHTML = '🔁'; } const prevBtn = playerContainer.querySelector('.prev-btn'); const nextBtn = playerContainer.querySelector('.next-btn'); if (playQueue.length > 0 && currentQueueIndex !== -1) { prevBtn.disabled = currentQueueIndex <= 0; nextBtn.disabled = currentQueueIndex >= playQueue.length - 1 && audioPlayerState.repeatMode !== 'all'; } else { prevBtn.disabled = true; nextBtn.disabled = true; } updateQueueDisplay(); }
        function playPreviousInQueue() { if (currentQueueIndex > 0) { playQueueItem(currentQueueIndex - 1); } }
        function toggleShuffle() { audioPlayerState.isShuffle = !audioPlayerState.isShuffle; if (audioPlayerState.isShuffle) { audioPlayerState.unshuffledQueue = [...playQueue]; if (currentQueueIndex !== -1 && currentQueueIndex < playQueue.length) { const currentItem = playQueue[currentQueueIndex]; const tail = playQueue.filter((_,idx) => idx !== currentQueueIndex); for (let i = tail.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [tail[i], tail[j]] = [tail[j], tail[i]]; } playQueue = [currentItem, ...tail]; currentQueueIndex = 0; } showToast("शफल चालू।", "success"); } else { if (audioPlayerState.unshuffledQueue.length > 0) { const currentUrl = playQueue[currentQueueIndex]?.url; playQueue = [...audioPlayerState.unshuffledQueue]; currentQueueIndex = playQueue.findIndex(item => item.url === currentUrl); if (currentQueueIndex === -1 && playQueue.length > 0) currentQueueIndex = 0; } showToast("शफल बंद।", "info"); } updateQueueDisplay(); saveQueue(); updatePlayerUI(); }
        function toggleRepeat() { const modes = ['off', 'all', 'one']; const currentIndexVal = modes.indexOf(audioPlayerState.repeatMode); audioPlayerState.repeatMode = modes[(currentIndexVal + 1) % modes.length]; if (audioPlayerState.repeatMode === 'off') showToast("रिपीट बंद।"); if (audioPlayerState.repeatMode === 'all') showToast("पूरी प्लेलिस्ट रिपीट करें।"); if (audioPlayerState.repeatMode === 'one') showToast("यह ट्रैक रिपीट करें।"); updatePlayerUI(); saveQueue(); }
        function updateAudioProgress(e) { const { duration, currentTime } = e.target; const playerContainer = document.getElementById('audioPlayerContainer'); if (duration && playerContainer && isFinite(duration) && isFinite(currentTime)) { const progressPercent = (currentTime / duration) * 100; const progressBar = playerContainer.querySelector('.progress-bar'); progressBar.value = progressPercent; progressBar.style.backgroundSize = `${progressPercent}% 100%`; playerContainer.querySelector('.current-time').textContent = formatTime(currentTime); playerContainer.querySelector('.total-time').textContent = formatTime(duration); } else if (playerContainer) { playerContainer.querySelector('.current-time').textContent = formatTime(0); playerContainer.querySelector('.total-time').textContent = formatTime(0); }}
        function seekAudio(value) { if (currentAudioElement && currentAudioElement.duration && isFinite(currentAudioElement.duration)) { currentAudioElement.currentTime = (value / 100) * currentAudioElement.duration; } }
        function formatTime(seconds) { if (!isFinite(seconds) || seconds < 0) return "0:00"; const floorSeconds = Math.floor(seconds); const m = Math.floor(floorSeconds / 60); const s = floorSeconds % 60; return `${m}:${s.toString().padStart(2, '0')}`; }
        
        function startPlayback(itemData) { if (!itemData) { console.warn("startPlayback called with null/undefined item"); stopPlayback(); hideAudioPlayer(); return; } stopPlayback(); audioPlayerState.currentItem = itemData; isPlaying = true; isPaused = false; updateMediaSession(itemData, 'playing'); if (itemData.type === 'youtube') { /* Handled by YouTube player's onReady event */ } else { document.getElementById('audioPlayerContainer').style.display = 'flex'; updatePlayerUI(); } if (itemData.type === 'youtube') { /* Handled by YouTube player's onReady event */ } else if (itemData.audioUrl) { playDirectAudio(itemData); } else if (itemData.textContent) { const method = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; const savedPosition = getPlaybackPosition(itemData.url); if (method === 'local') { playLocalTTSInternal(itemData, savedPosition); } else { playStreamTTSInternal(itemData, savedPosition); } } else { showToast("इस आइटम के लिए कोई ऑडियो सामग्री उपलब्ध नहीं है।", "warning"); stopPlayback(); hideAudioPlayer(); } }
        function pausePlayback() { if (!isPlaying) return; if(ytPlayer && ytPlayer.pauseVideo) { ytPlayer.pauseVideo(); } if (currentAudioElement) { currentAudioElement.pause(); } else if (localStorage.getItem(STORAGE_KEY_TTS_METHOD) === 'local' && speechApiSupported && localSpeechSynth && localSpeechSynth.speaking) { localSpeechSynth.pause(); } isPlaying = false; isPaused = true; updatePlayerUI(); updateMediaSession(audioPlayerState.currentItem, 'paused'); }
        function resumePlayback() { if (!isPaused || !audioPlayerState.currentItem) return; isPaused = false; isPlaying = true; if(ytPlayer && ytPlayer.playVideo) { ytPlayer.playVideo(); } if (currentAudioElement) { currentAudioElement.play().catch(e => { console.error("Error resuming audio:", e); stopPlayback();}); } else if (localStorage.getItem(STORAGE_KEY_TTS_METHOD) === 'local' && speechApiSupported && localSpeechSynth && localSpeechSynth.paused) { localSpeechSynth.resume(); } updatePlayerUI(); updateMediaSession(audioPlayerState.currentItem, 'playing'); }
        function stopPlayback() { const currentItemForPos = audioPlayerState.currentItem; if (currentItemForPos?.url && (isPlaying || isPaused)) { let positionToSave = -1; let type = 'tts'; if (currentItemForPos.audioUrl && currentAudioElement && currentAudioElement.duration > 0) { if (currentAudioElement.currentTime < currentAudioElement.duration - 2) { positionToSave = currentAudioElement.currentTime; type = 'podcast'; } else { clearPlaybackPosition(currentItemForPos.url); } } else if (!currentItemForPos.audioUrl && currentItemForPos.textContent) { const method = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; if (method === 'stream') positionToSave = currentlyPlayingChunkIndex; else if (method === 'local') positionToSave = currentArticleTotalChunks - localTtsQueue.length -1; type = method; if (positionToSave >= currentArticleTotalChunks -1) { clearPlaybackPosition(currentItemForPos.url); positionToSave = -1;} } if (positionToSave >= 0) { savePlaybackPosition(currentItemForPos.url, type, positionToSave); } } stopVisualization(); if (currentStreamController) { currentStreamController.abort(); currentStreamController = null; } if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.removeAttribute('src'); currentAudioElement.load(); currentAudioElement = null; } if (speechApiSupported && localSpeechSynth) { localSpeechSynth.cancel(); } if (ytPlayer && ytPlayer.destroy) { try { ytPlayer.destroy(); } catch(e){} ytPlayer = null; } isPlaying = false; isPaused = false; localTtsQueue = []; preloadedAudioBlobs = {}; allTextChunksForStream = []; currentlyPlayingChunkIndex = -1; if (mediaSessionSupported) { navigator.mediaSession.playbackState = 'none'; navigator.mediaSession.metadata = null; } updatePlayerUI(); }
        function playDirectAudio(itemData) { currentAudioElement = new Audio(itemData.audioUrl); if (visualizerContext.audioCtx) setupVisualizer(currentAudioElement); currentAudioElement.addEventListener('timeupdate', updateAudioProgress); currentAudioElement.addEventListener('loadedmetadata', updateAudioProgress); currentAudioElement.playbackRate = parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'); currentAudioElement.play().catch(err => { showToast(`ऑडियो चलाने में त्रुटि: ${err.message}`, "error"); console.error("Audio play error:", err); stopPlayback(); }); currentAudioElement.onended = () => { if (isPlaying) { clearPlaybackPosition(audioPlayerState.currentItem.url); if (audioPlayerState.repeatMode === 'one') { startPlayback(audioPlayerState.currentItem); return; } if (stopAtArticleEnd) { showToast("आइटम समाप्त। स्लीप टाइमर के अनुसार ऑडियो रोका जा रहा है।", "info"); cancelSleepTimer(); stopPlayback(); } else { const willPlayNext = playNextInQueueOrAutoplay(); if (!willPlayNext) stopPlayback(); } } }; currentAudioElement.onerror = (e) => { showToast(`ऑडियो प्लेबैक त्रुटि`, "error"); console.error("Audio element error event:", e); stopPlayback(); }; const savedPosition = getPlaybackPosition(itemData.url); if (savedPosition && savedPosition.type === 'podcast' && savedPosition.position > 0) { currentAudioElement.addEventListener('canplay', () => { currentAudioElement.currentTime = savedPosition.position; }, { once: true }); } }
        function playLocalTTSInternal(itemData, savedPosition = null) { if (!speechApiSupported || !itemData.textContent) { showToast("बोलने के लिए टेक्स्ट नहीं है या डिवाइस TTS समर्थित नहीं है।", "error"); stopPlayback(); return; } const fullText = (itemData.title || "") + ". " + itemData.textContent; const allChunks = fullText.match(/[^.!?]+[.!?]*\s*/g) || [fullText]; currentArticleTotalChunks = allChunks.length; let startIndex = 0; if (savedPosition && (savedPosition.type === 'local' || savedPosition.type === 'tts') && savedPosition.position < allChunks.length) { startIndex = savedPosition.position; } localTtsQueue = allChunks.slice(startIndex); if (localTtsQueue.length === 0) { showToast("बोलने के लिए कोई टेक्स्ट नहीं मिला।", 'error'); stopPlayback(); return; } processLocalTtsQueueInternal(); }
        function processLocalTtsQueueInternal() { if (!isPlaying || localTtsQueue.length === 0) { if (isPlaying && audioPlayerState.currentItem) { clearPlaybackPosition(audioPlayerState.currentItem.url); if (audioPlayerState.repeatMode === 'one') { startPlayback(audioPlayerState.currentItem); return; } if (stopAtArticleEnd) { showToast("आइटम समाप्त। स्लीप टाइमर के अनुसार ऑडियो रोका जा रहा है।", "info"); cancelSleepTimer(); stopPlayback(); } else { const willPlayNext = playNextInQueueOrAutoplay(); if (!willPlayNext) stopPlayback(); } } return; } if (localSpeechSynth.speaking || localSpeechSynth.pending) { setTimeout(processLocalTtsQueueInternal, 100); return; } const chunk = localTtsQueue.shift(); if (!chunk || !chunk.trim()) { processLocalTtsQueueInternal(); return; } const utterance = new SpeechSynthesisUtterance(chunk); const rate = parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'); const voiceURI = localStorage.getItem(STORAGE_KEY_TTS_VOICE); const voices = localSpeechSynth.getVoices(); if (voices.length === 0 && speechApiSupported) { showToast("आवाज़ें अभी भी लोड हो रही हैं...", "warning"); localTtsQueue.unshift(chunk); setTimeout(processLocalTtsQueueInternal, 1000); return; } const selectedVoice = voices.find(v => v.voiceURI === voiceURI); utterance.lang = selectedVoice ? selectedVoice.lang : 'hi-IN'; utterance.rate = rate; if (selectedVoice) utterance.voice = selectedVoice; utterance.onend = () => { if(isPlaying) setTimeout(processLocalTtsQueueInternal, 50); }; utterance.onerror = (e) => { if (e.error === 'interrupted') return; console.error("SpeechSynthesisUtterance Error:", e); showToast(`डिवाइस TTS में त्रुटि: ${e.error || 'अज्ञात'}`, 'error', 6000); stopPlayback(); }; setTimeout(() => { if(isPlaying) localSpeechSynth.speak(utterance); }, 10); }
        async function playStreamTTSInternal(itemData, savedPosition = null) { const fullText = (itemData.title || "") + ". " + (itemData.textContent || ""); allTextChunksForStream = fullText.replace(/\s+/g, ' ').trim().match(/.{1,180}/g) || []; currentArticleTotalChunks = allTextChunksForStream.length; if (allTextChunksForStream.length === 0) { showToast("बोलने के लिए टेक्स्ट नहीं है।", "error"); stopPlayback(); return; } currentlyPlayingChunkIndex = 0; if (savedPosition && (savedPosition.type === 'stream' || savedPosition.type === 'tts') && savedPosition.position < currentArticleTotalChunks) { currentlyPlayingChunkIndex = savedPosition.position; } currentStreamController = new AbortController(); preloadedAudioBlobs = {}; processAudioStreamQueue(); }
        async function preloadNextAudioChunk(chunkIndexToLoad) { if (chunkIndexToLoad >= allTextChunksForStream.length || preloadedAudioBlobs[chunkIndexToLoad] || !isPlaying || isPaused) { return; } const chunkText = allTextChunksForStream[chunkIndexToLoad]; if (!chunkText) return; try { const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunkText)}&tl=hi&client=tw-ob`; const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`; const response = await fetch(proxyUrl, { signal: currentStreamController?.signal }); if (!response.ok) { console.error(`Preload API Error ${response.status} for chunk ${chunkIndexToLoad}`); return; } const blob = await response.blob(); if (blob.size === 0) { console.error(`Empty audio data for preloaded chunk ${chunkIndexToLoad}`); return; } preloadedAudioBlobs[chunkIndexToLoad] = blob; } catch (error) { if (error.name !== 'AbortError') { console.error(`Error preloading chunk ${chunkIndexToLoad}:`, error.message); } } }
        async function processAudioStreamQueue() { if (!isPlaying) return; if (currentlyPlayingChunkIndex >= allTextChunksForStream.length) { if (isPlaying && audioPlayerState.currentItem) { clearPlaybackPosition(audioPlayerState.currentItem.url); if (audioPlayerState.repeatMode === 'one') { startPlayback(audioPlayerState.currentItem); return; } if (stopAtArticleEnd) { showToast("आइटम समाप्त। स्लीप टाइमर के अनुसार ऑडियो रोका जा रहा है।", "info"); cancelSleepTimer(); stopPlayback(); } else { const willPlayNext = playNextInQueueOrAutoplay(); if (!willPlayNext) stopPlayback(); } } return; } if (isPaused) return; let audioBlobToPlay = preloadedAudioBlobs[currentlyPlayingChunkIndex]; let audioUrl; if (audioBlobToPlay) { audioUrl = URL.createObjectURL(audioBlobToPlay); delete preloadedAudioBlobs[currentlyPlayingChunkIndex]; } else { const chunkText = allTextChunksForStream[currentlyPlayingChunkIndex]; if (!chunkText) { currentlyPlayingChunkIndex++; processAudioStreamQueue(); return; } try { const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunkText)}&tl=hi&client=tw-ob`; const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`; const response = await fetch(proxyUrl, { signal: currentStreamController?.signal }); if (!response.ok) throw new Error(`API Error ${response.status} for chunk ${currentlyPlayingChunkIndex}`); const blob = await response.blob(); if (blob.size === 0) throw new Error(`Empty audio data for chunk ${currentlyPlayingChunkIndex}`); audioUrl = URL.createObjectURL(blob); } catch (error) { if (error.name !== 'AbortError') { showToast(`स्ट्रीमिंग त्रुटि (chunk ${currentlyPlayingChunkIndex}): ${error.message}`, 'error'); stopPlayback(); } return; } } currentAudioElement = new Audio(audioUrl); if (visualizerContext.audioCtx) setupVisualizer(currentAudioElement); currentAudioElement.addEventListener('timeupdate', updateAudioProgress); currentAudioElement.addEventListener('loadedmetadata', updateAudioProgress); currentAudioElement.playbackRate = parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'); currentAudioElement.play().catch(err => { showToast(`ऑडियो चलाने में त्रुटि (chunk ${currentlyPlayingChunkIndex}): ${err.message}`, "error"); console.error("Audio play error:", err); stopPlayback(); }); currentAudioElement.onended = () => { URL.revokeObjectURL(audioUrl); if (isPlaying) { currentlyPlayingChunkIndex++; processAudioStreamQueue(); } }; currentAudioElement.onerror = (e) => { URL.revokeObjectURL(audioUrl); showToast(`ऑडियो प्लेबैक त्रुटि (chunk ${currentlyPlayingChunkIndex})`, "error"); console.error("Audio element error event:", e); stopPlayback(); }; for (let i = 1; i <= PRELOAD_AHEAD_COUNT; i++) { const indexToPreload = currentlyPlayingChunkIndex + i; if (indexToPreload < allTextChunksForStream.length && !preloadedAudioBlobs[indexToPreload]) { preloadNextAudioChunk(indexToPreload).catch(err => console.error("Preload promise rejected:", err)); } } }
        function removeUrlsFromText(text) { if (!text) return ""; const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; return text.replace(urlRegex, '').replace(/\s+/g, ' ').trim(); }
        function toggleTheme(themeName) { document.body.classList.remove('dark-mode', 'sepia-mode', 'light-mode', 'high-contrast-mode'); if (themeName === 'dark') document.body.classList.add('dark-mode'); else if (themeName === 'sepia') document.body.classList.add('sepia-mode'); else if (themeName === 'high-contrast') document.body.classList.add('high-contrast-mode'); else document.body.classList.add('light-mode'); localStorage.setItem(STORAGE_KEY_THEME, themeName); }
        function applySavedTheme() { const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light'; toggleTheme(savedTheme); }
        let previousToolName = '';
        function openTool(evt, toolName) { const currentActiveTab = document.querySelector('.tab-link.active'); if (evt && currentActiveTab === evt.currentTarget && document.getElementById(toolName).style.display === 'block') return; Object.keys(autoScrollStates).forEach(key => { const state = autoScrollStates[key]; if (state.isScrolling) { if(state.animationFrameId) cancelAnimationFrame(state.animationFrameId); state.isScrolling = false; const btnId = key === 'library_article' ? `#autoScrollPlayPauseBtnLib` : `#autoScrollPlayPauseBtn_extractor_${key.replace(/[^a-zA-Z0-9]/g, '')}`; const btn = document.querySelector(btnId); if(btn) btn.textContent = '▶️ शुरू करें'; } }); if (previousToolName === 'MyLibrary' && toolName !== 'MyLibrary') { document.getElementById('duplicates-container').style.display = 'none'; document.getElementById('library-list-container').style.display = 'block'; } if (previousToolName === 'MyLibrary') { const contentWrapper = document.getElementById('lib-article-text-content'); if (contentWrapper) contentWrapper.onscroll = null; clearTimeout(scrollSaveTimeout); const libProgressBarContainer = document.getElementById('library-reading-progress-container'); if (libProgressBarContainer) libProgressBarContainer.style.display = 'none'; } document.querySelectorAll('.extractor-reading-progress-container').forEach(el => el.style.display = 'none'); document.querySelectorAll('.tool-content').forEach(el => el.style.display = 'none'); document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active')); const toolElement = document.getElementById(toolName); if (toolElement) toolElement.style.display = 'block'; const targetTab = evt ? evt.currentTarget : document.querySelector(`.tab-link[onclick*="'${toolName}'"]`); if (targetTab) targetTab.classList.add('active'); if (toolName === 'MyLibrary' || toolName === 'Bookmarks' || toolName === 'RSSFeeds' || toolName === 'YouTubeBrowser' || toolName === 'LinkCollector') { if(toolName === 'MyLibrary') { loadLibrary(); populateTagFilter(); } if(toolName === 'Bookmarks') { loadBookmarks(); } if (toolName === 'RSSFeeds') { displaySubscribedFeeds(); if(getSubscribedFeeds().length > 0 && !document.getElementById('rssArticlesList').hasChildNodes()){ displayRssFeedContent(0); } updateRssFeedCount(); } if (toolName === 'YouTubeBrowser' && !document.getElementById('youtube-browser-results').hasChildNodes()) { loadTrendingYouTubeVideos(); } document.getElementById('internalNavHistoryContainer').style.display = 'none'; document.getElementById('toggleCrawlBtn').style.display = 'none'; } else if (toolName === 'ArticleExtractor') { updateHistoryButtons(); } previousToolName = toolName; }
        async function fetchWithProxy(url) { const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(url)}`; try { const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(20000) }); if (!response.ok) throw new Error(`प्रॉक्सी सर्वर से जवाब नहीं मिला (स्टेटस: ${response.status})`); return await response.text(); } catch (error) { if (error.name === 'AbortError' || error.name === 'TimeoutError') { throw new Error('अनुरोध में बहुत अधिक समय लगा (टाइमआउट)।'); } throw error; } }
        async function ae_startExtraction(isNavigationAction = false) { stopPlayback(); const urlInput = document.getElementById('articleUrl').value.trim(); const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); if (!urlInput) { showToast('कृपया एक URL डालें।', 'error'); return; } const youtubeVideoRegex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; const youtubePlaylistRegex = /[?&]list=([a-zA-Z0-9_-]+)/; const youtubeChannelRegex = /youtube\.com\/(@[\w.-]+|c\/[\w.-]+|channel\/[\w-]+)/; const videoMatch = urlInput.match(youtubeVideoRegex); const playlistMatch = urlInput.match(youtubePlaylistRegex); const channelMatch = urlInput.match(youtubeChannelRegex); loadingDiv.style.display = 'block'; resultDiv.innerHTML = ''; if (!isNavigatingHistory && !isNavigationAction) addToHistory(urlInput); if (videoMatch && videoMatch[1] && !playlistMatch) { await ae_processYouTubeUrl(urlInput, videoMatch[1]); } else if (playlistMatch && playlistMatch[1]) { await ae_processYouTubePlaylist(playlistMatch[1]); } else if (channelMatch && channelMatch[1]) { await ae_processYouTubeChannel(urlInput); } else { await ae_processArticleUrl(urlInput, isNavigationAction); } loadingDiv.style.display = 'none'; }
        async function ae_processArticleUrl(url, isNavigationAction = false) { const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); try { const initialUrlObj = new URL(url); loadingDiv.innerText = "पेज का विश्लेषण..."; const shouldCrawl = !isNavigationAction && document.getElementById('crawlSiteToggle').checked; const html = await fetchWithProxy(initialUrlObj.href); const doc = new DOMParser().parseFromString(html, "text/html"); const base = new URL(initialUrlObj.href); const article = new Readability(doc.cloneNode(true)).parse(); if (article && article.content && article.title) { resultDiv.appendChild(createStoryElement(article, initialUrlObj.href)); allFoundLinks.add(initialUrlObj.href); } else { console.warn("Readability failed for:", initialUrlObj.href); resultDiv.innerHTML = `<p>इस URL से आर्टिकल कंटेंट नहीं निकाला जा सका।</p>`; } if (shouldCrawl) { loadingDiv.innerText = "संबंधित लेख खोजे जा रहे हैं..."; const linksToProcess = new Set(); doc.querySelectorAll('a[href]').forEach(a => { try { const href = a.getAttribute('href'); if (!href || href.startsWith('#') || href.startsWith('javascript:')) return; const absoluteUrl = new URL(href, base.href); if (absoluteUrl.hostname === base.hostname && !absoluteUrl.href.match(/(youtube\.com|youtu\.be)/)) { linksToProcess.add(absoluteUrl.href.split('#')[0]); } } catch (e) {} }); const initialSize = allFoundLinks.size; allFoundLinks = new Set([...allFoundLinks, ...linksToProcess]); if (allFoundLinks.size > initialSize) { processNextLink(); } } } catch (error) { resultDiv.innerHTML = `<p>त्रुटि: ${error.message}</p>`; showToast(`त्रुटि: ${error.message}`, 'error'); } }
        async function ae_processYouTubeUrl(url, videoId) { const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); loadingDiv.innerText = "YouTube वीडियो डेटा लोड हो रहा है..."; try { const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`; const oembedProxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(oembedUrl)}`; const metaResponse = await fetch(oembedProxyUrl); if (!metaResponse.ok) throw new Error('वीडियो मेटाडेटा प्राप्त नहीं कर सका।'); const metaData = await metaResponse.json(); let transcriptText = null, transcriptError = ''; try { const transcriptProxyUrl = `${MY_PRIVATE_PROXY}/yt-transcript?videoId=${videoId}`; const transcriptResponse = await fetch(transcriptProxyUrl, { signal: AbortSignal.timeout(20000) }); if (transcriptResponse.ok) { const transcriptData = await transcriptResponse.json(); if(Array.isArray(transcriptData) && transcriptData.length > 0) { transcriptText = transcriptData.map(t => t.text).join(' '); } else { transcriptError = 'इस वीडियो के लिए कोई ट्रांसक्रिप्ट नहीं मिला।'; } } else { const errorData = await transcriptResponse.json().catch(()=>({})); transcriptError = errorData.error || 'इस वीडियो के लिए ट्रांसक्रिप्ट उपलब्ध नहीं है या उसे प्राप्त नहीं किया जा सका।'; } } catch (e) { console.error("Transcript fetch error:", e); transcriptError = 'ट्रांसक्रिप्ट प्राप्त करने में त्रुटि हुई।'; } const itemData = { type: 'youtube', title: metaData.title || "YouTube Video", byline: metaData.author_name || "Unknown Author", url: url, videoId: videoId, textContent: transcriptText, transcriptError: transcriptError, siteName: 'YouTube' }; resultDiv.appendChild(createStoryElement(itemData, url)); } catch (error) { resultDiv.innerHTML = `<p>YouTube वीडियो प्रोसेस करने में त्रुटि: ${error.message}</p>`; showToast(`त्रुटि: ${error.message}`, 'error'); } }
        async function ae_processYouTubeChannel(channelUrl) { const loadingDiv = document.getElementById('ae_loading'); loadingDiv.innerText = "YouTube चैनल आईडी प्राप्त किया जा रहा है..."; try { const channelIdProxyUrl = `${MY_PRIVATE_PROXY}/yt-channel-id?url=${encodeURIComponent(channelUrl)}`; const response = await fetch(channelIdProxyUrl); if (!response.ok) throw new Error('चैनल आईडी प्राप्त करने में विफल।'); const data = await response.json(); if (data.error || !data.channelId) throw new Error(data.error || 'इस URL से कोई चैनल आईडी नहीं मिला।'); const uploadsPlaylistId = 'UU' + data.channelId.substring(2); await ae_processYouTubePlaylist(uploadsPlaylistId, data.channelTitle || "चैनल अपलोड्स"); } catch (error) { document.getElementById('ae_result').innerHTML = `<p>YouTube चैनल को प्रोसेस करने में त्रुटि: ${error.message}</p>`; showToast(`त्रुटि: ${error.message}`, 'error'); } }
        async function ae_processYouTubePlaylist(playlistId, playlistTitle = "YouTube प्लेलिस्ट") { const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); loadingDiv.innerText = `प्लेलिस्ट "${playlistTitle}" को क्यू में जोड़ा जा रहा है...`; try { const playlistItemsProxyUrl = `${MY_PRIVATE_PROXY}/yt-playlist-items?playlistId=${playlistId}`; const response = await fetch(playlistItemsProxyUrl); if (!response.ok) throw new Error('प्लेलिस्ट वीडियो प्राप्त करने में विफल।'); const data = await response.json(); if (!data.items || data.items.length === 0) { resultDiv.innerHTML = `<p>इस प्लेलिस्ट में कोई वीडियो नहीं मिला या यह निजी है।</p>`; return; } clearQueue(); const itemsForQueue = data.items.map(video => ({ type: 'youtube', title: video.title, url: `https://www.youtube.com/watch?v=${video.videoId}`, videoId: video.videoId, byline: data.playlistTitle || playlistTitle, siteName: 'YouTube', textContent: null })); itemsForQueue.forEach(item => addToQueue(item, false, false)); if (playQueue.length > 0) { showToast(`${playQueue.length} वीडियो सफलतापूर्वक क्यू में जोड़े गए!`, 'success'); openTool(null, 'MyLibrary'); startQueuePlayback(); } else { showToast("क्यू में कोई वीडियो नहीं जोड़ा जा सका।", "error"); } } catch (error) { resultDiv.innerHTML = `<p>YouTube प्लेलिस्ट को प्रोसेस करने में त्रुटि: ${error.message}</p>`; showToast(`त्रुटि: ${error.message}`, 'error'); } }
        function createStoryElement(item, sourceUrl) { const storyDiv = document.createElement('div'); storyDiv.className = 'single-story'; const storyIdSuffix = btoa(encodeURIComponent(sourceUrl)).replace(/[^a-zA-Z0-9]/g, ''); storyDiv.dataset.itemKey = `extractor_${storyIdSuffix}`; storyDiv.dataset.sourceUrl = sourceUrl; const itemDataForStorage = { type: item.type || 'article', title: item.title || "अज्ञात शीर्षक", byline: item.byline, url: sourceUrl, siteName: item.siteName, ...(item.type === 'youtube' ? { videoId: item.videoId, textContent: item.textContent } : { content: item.content, textContent: item.textContent, length: item.length, excerpt: item.excerpt }) }; storyDiv.dataset.itemData = JSON.stringify(itemDataForStorage); storyDiv.dataset.textContentForSearch = (item.title + " " + (item.textContent || "")).toLowerCase(); const headerDiv = document.createElement('div'); headerDiv.className = 'story-header'; const titleH3 = document.createElement('h3'); titleH3.textContent = item.title || "शीर्षक उपलब्ध नहीं"; const headerButtons = document.createElement('div'); headerButtons.className = 'header-buttons'; const listenBtn = document.createElement('button'); listenBtn.textContent = '▶️ सुनें'; listenBtn.title = 'आर्टिकल/ट्रांसक्रिप्ट सुनें'; listenBtn.onclick = () => { clearQueue(); addToQueue(JSON.parse(storyDiv.dataset.itemData)); }; if (!item.textContent) { listenBtn.disabled = true; listenBtn.style.opacity = 0.5; } const mp3Btn = document.createElement('button'); mp3Btn.innerHTML = '🗣️ MP3'; mp3Btn.title = 'MP3 ऑडियो डाउनलोड करें'; mp3Btn.onclick = (e) => downloadTextAsMp3(item.textContent, item.title, e.currentTarget); if (!item.textContent) { mp3Btn.disabled = true; mp3Btn.style.opacity = 0.5; } const copyBtn = document.createElement('button'); copyBtn.innerHTML = '📄 कॉपी'; copyBtn.title = 'आर्टिकल/ट्रांसक्रिप्ट कॉपी करें'; copyBtn.onclick = () => copyArticleContent(itemDataForStorage); if (!item.textContent) { copyBtn.disabled = true; copyBtn.style.opacity = 0.5; } const shareBtn = document.createElement('button'); shareBtn.innerHTML = '🔗 शेयर'; shareBtn.title = 'आर्टिकल/ट्रांसक्रिप्ट शेयर करें'; shareBtn.style.backgroundColor = 'var(--success-color)'; shareBtn.onclick = () => shareLibraryArticle(itemDataForStorage); if (!item.textContent) { shareBtn.disabled = true; shareBtn.style.opacity = 0.5; } const saveBtn = document.createElement('button'); saveBtn.className = 'save-btn'; saveBtn.innerHTML = isSaved(sourceUrl) ? '❤️ सेव है' : '🤍 सेव करें'; saveBtn.title = isSaved(sourceUrl) ? 'लाइब्रेरी से हटाएं' : 'लाइब्रेरी में सेव करें'; if (isSaved(sourceUrl)) saveBtn.classList.add('saved'); saveBtn.onclick = () => toggleSaveArticle(itemDataForStorage, sourceUrl, saveBtn); headerButtons.append(listenBtn, mp3Btn, copyBtn, shareBtn, saveBtn); headerDiv.append(titleH3, headerButtons); storyDiv.innerHTML = ''; storyDiv.appendChild(headerDiv); if (item.type === 'youtube') { const videoContainer = document.createElement('div'); videoContainer.className = 'youtube-video-container'; videoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.videoId}" title="${item.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; storyDiv.appendChild(videoContainer); if (item.textContent || item.transcriptError) { const transcriptToggleBtn = document.createElement('button'); transcriptToggleBtn.className = 'tool-btn-secondary'; transcriptToggleBtn.style.cssText = 'margin-top: 10px; font-size: 0.9em; margin-left:0;'; transcriptToggleBtn.textContent = 'ट्रांसक्रिप्ट दिखाएं'; const transcriptContainer = document.createElement('div'); transcriptContainer.className = 'youtube-transcript-content'; transcriptContainer.style.display = 'none'; transcriptContainer.innerHTML = item.textContent ? `<p>${item.textContent}</p>` : `<p><em>${item.transcriptError}</em></p>`; transcriptToggleBtn.onclick = () => { const isHidden = transcriptContainer.style.display === 'none'; transcriptContainer.style.display = isHidden ? 'block' : 'none'; transcriptToggleBtn.textContent = isHidden ? 'ट्रांसक्रिप्ट छुपाएं' : 'ट्रांसक्रिप्ट दिखाएं'; }; storyDiv.appendChild(transcriptToggleBtn); storyDiv.appendChild(transcriptContainer); } } else { const wordCount = item.textContent ? item.textContent.split(/\s+/).filter(Boolean).length : 0; const readingTime = Math.ceil(wordCount / 200); const authorP = document.createElement('p'); authorP.innerHTML = `<em style="font-size: 0.9em;">लेखक: ${item.byline || 'उपलब्ध नहीं'} | पढ़ने का समय: ~${readingTime} मिनट</em>`; const contentDiv = document.createElement('div'); contentDiv.className = 'article-body-content'; contentDiv.id = `article-content-${storyIdSuffix}`; if (item.content) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = item.content; const displayMode = localStorage.getItem(STORAGE_KEY_DISPLAY_MODE) || 'image-text'; if (displayMode === 'text-only') { tempDiv.querySelectorAll('img, figure, picture').forEach(el => el.remove()); } else { tempDiv.querySelectorAll('img').forEach(img => { const originalSrc = img.getAttribute('src') || img.dataset.src; if (originalSrc) { try { img.src = new URL(originalSrc, sourceUrl).href; } catch (e) { console.warn("Invalid image URL:", originalSrc); } } img.loading = 'lazy'; img.style.cssText = 'max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px;'; }); } tempDiv.querySelectorAll('a[href]').forEach(linkElement => { const originalHref = linkElement.getAttribute('href'); if (originalHref && !originalHref.startsWith('#') && !originalHref.startsWith('javascript:')) { try { const absoluteUrl = new URL(originalHref, sourceUrl).href; linkElement.style.cssText = 'color: var(--primary-color); text-decoration: underline; cursor: pointer;'; linkElement.title = `रीडर में खोलें: ${absoluteUrl.substring(0,70)}...`; linkElement.setAttribute('data-reader-target-url', absoluteUrl); linkElement.href = 'javascript:void(0);'; linkElement.removeAttribute('target'); } catch (e) { linkElement.target = '_blank'; linkElement.rel = 'noopener noreferrer'; } } }); contentDiv.innerHTML = tempDiv.innerHTML; } else { contentDiv.innerHTML = "<p><em>इस आर्टिकल का कंटेंट लोड नहीं हो सका।</em></p>"; } storyDiv.append(authorP, document.createElement('hr'), contentDiv); } if (document.querySelectorAll('#ae_result .single-story').length >= 0) { const playAllBtn = document.getElementById('playAllExtractedBtn'); if (playAllBtn) playAllBtn.style.display = 'inline-block'; } return storyDiv; }
        
        function formatShareText(itemData) {
            const filteredTextContent = removeUrlsFromText(itemData.textContent || itemData.description || '');
            const textToFormat = `शीर्षक: ${itemData.title}\n\n${filteredTextContent}`;
            return textToFormat;
        }

        async function copyArticleContent(itemData) { 
            if (!itemData || !itemData.title || !itemData.textContent) { 
                showToast('कॉपी करने के लिए आवश्यक डेटा नहीं मिला।', 'error'); 
                return; 
            }
            const textToCopy = formatShareText(itemData);
            try { 
                if (navigator.clipboard && window.isSecureContext) { 
                    await navigator.clipboard.writeText(textToCopy); 
                    showToast('टेक्स्ट सफलतापूर्वक कॉपी हुआ!', 'success'); 
                } else { 
                    const textArea = document.createElement('textarea'); 
                    textArea.value = textToCopy; 
                    textArea.style.position = 'fixed'; 
                    textArea.style.opacity = '0'; 
                    document.body.appendChild(textArea); 
                    textArea.focus(); 
                    textArea.select(); 
                    try { 
                        const successful = document.execCommand('copy'); 
                        if (successful) { 
                            showToast('टेक्स्ट कॉपी हुआ (fallback)!', 'success'); 
                        } else { 
                            throw new Error('Fallback copy command failed.'); 
                        } 
                    } catch (err) { 
                        console.error('Fallback copy error:', err); 
                        showToast('कॉपी विफल। ब्राउज़र ने अनुमति नहीं दी।', 'error', 5000); 
                    } 
                    document.body.removeChild(textArea); 
                } 
            } catch (err) { 
                console.error('कॉपी करने में विफल:', err); 
                showToast('कॉपी विफल। ब्राउज़र ने अनुमति नहीं दी।', 'error', 5000); 
            } 
        }
        
        async function shareLibraryArticle(itemData) {
            if (!itemData || !itemData.title) {
                showToast('शेयर करने के लिए आवश्यक डेटा नहीं मिला।', 'error');
                return;
            }
            const shareText = formatShareText(itemData);
            const dataToShare = {
                title: itemData.title,
                text: shareText,
                url: itemData.url && !itemData.url.startsWith('blob:') ? itemData.url : undefined
            };

            if (navigator.share) {
                try {
                    await navigator.share(dataToShare);
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        showToast('शेयरिंग विफल हुई।', 'warning');
                    }
                }
            } else {
                showToast('आपका ब्राउज़र शेयरिंग का समर्थन नहीं करता।', 'warning');
            }
        }

        async function playAllExtractedArticles() { const resultDiv = document.getElementById('ae_result'); const storyElements = resultDiv.querySelectorAll('.single-story'); if (storyElements.length === 0) { showToast("प्ले करने के लिए कोई आइटम नहीं मिला।", "warning"); return; } const itemsToProcess = Array.from(storyElements).map(el => JSON.parse(el.dataset.itemData)).filter(Boolean); if (itemsToProcess.length === 0) { showToast("प्ले करने के लिए कोई वैध आइटम नहीं मिला।", "error"); return; } clearQueue(); itemsToProcess.forEach(item => addToQueue(item, false, false)); startQueuePlayback(); showToast(`${itemsToProcess.length} आइटम सफलतापूर्वक क्यू में जोड़े गए!`, "success"); openTool(null, 'MyLibrary'); }
        async function downloadTextAsMp3(text, filename, btn) { const originalText = btn ? btn.innerHTML : ''; if (btn) { btn.innerHTML = 'प्रोसेसिंग...'; btn.disabled = true; } showToast('MP3 निर्माण शुरू हो रहा है...', 'info'); const cleanedText = (text || "").replace(/\s+/g, ' ').trim(); if (!cleanedText) { showToast('MP3 बनाने के लिए कोई टेक्स्ट नहीं है।', 'error'); if (btn) { btn.innerHTML = originalText; btn.disabled = false; } return; } const chunks = cleanedText.match(/.{1,180}/g) || [cleanedText]; const audioBlobs = []; try { for (let i = 0; i < chunks.length; i++) { if (btn) btn.innerHTML = `भाग ${i+1}/${chunks.length}...`; const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunks[i])}&tl=hi&client=tw-ob`; const audioResponse = await fetch(`${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`, { signal: AbortSignal.timeout(20000) }); if (!audioResponse.ok) throw new Error(`TTS API त्रुटि (स्टेटस: ${audioResponse.status})`); const blob = await audioResponse.blob(); if (blob.size === 0 || !blob.type.startsWith('audio/')) throw new Error('अमान्य ऑडियो डेटा'); audioBlobs.push(blob); } const combinedBlob = new Blob(audioBlobs, { type: 'audio/mpeg' }); const downloadUrl = URL.createObjectURL(combinedBlob); const a = document.createElement('a'); a.href = downloadUrl; const safeFilename = (filename || "audio").replace(/[^a-z0-9\u0900-\u097F\s._-]/gi, '_').replace(/\s+/g, '_'); a.download = `${safeFilename}.mp3`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(downloadUrl); showToast("MP3 डाउनलोड शुरू!", "success"); } catch (error) { showToast(`MP3 त्रुटि: ${error.message}`, 'error', 7000); } finally { if (btn) { btn.innerHTML = originalText; btn.disabled = false; } } }
        async function processNextLink() { if (isProcessing) return; const linksArray = Array.from(allFoundLinks); if (currentProcessIndex >= linksArray.length) { document.getElementById('ae_loading').style.display = 'none'; if(document.getElementById('ae_result').innerHTML === '') { document.getElementById('ae_result').innerHTML = `<p>कोई पठनीय आर्टिकल नहीं मिला।</p>`; } return; } const link = linksArray[currentProcessIndex]; if (currentProcessIndex === 0 && document.querySelector('#ae_result .single-story')) { currentProcessIndex++; processNextLink(); return; } isProcessing = true; const loadingDiv = document.getElementById('ae_loading'); loadingDiv.innerText = `आर्टिकल (${currentProcessIndex + 1}/${linksArray.length}) लोड हो रहा है: ${link.substring(0,50)}...`; try { const html = await fetchWithProxy(link); const doc = new DOMParser().parseFromString(html, "text/html"); doc.head.insertAdjacentHTML('beforeend', `<base href="${link}">`); const article = new Readability(doc, {charThreshold: 500}).parse(); if (article && article.content && article.title) { document.getElementById('ae_result').appendChild(createStoryElement(article, link)); } else {console.warn("Readability failed or insufficient content for (crawled):", link, article);} } catch (e) { console.warn(`Could not process article from ${link}: ${e.message}`); } finally { currentProcessIndex++; isProcessing = false; setTimeout(processNextLink, 50); } }
        function toggleDepthSelector() { document.getElementById('depthSelectorContainer').style.display = document.getElementById('crawlSiteToggle').checked ? 'inline-block' : 'none'; }
        function clearResults() { stopPlayback(); document.getElementById('ae_result').innerHTML = ''; document.getElementById('articleUrl').value = ''; allFoundLinks.clear(); currentProcessIndex = 0; navigationHistory = []; currentHistoryIndex = -1; updateHistoryButtons(); showToast("परिणाम साफ़।"); hideAudioPlayer(); audioPlayerState.currentItem = null; const playAllBtn = document.getElementById('playAllExtractedBtn'); if (playAllBtn) { playAllBtn.style.display = 'none'; } }
        function clearUrlInput() { const i = document.getElementById('articleUrl'); i.value = ''; i.focus(); }
        function filterExtractedArticles() { const term = document.getElementById('extractorSearch').value.toLowerCase(); document.querySelectorAll('#ae_result .single-story').forEach(div => { const text = (div.dataset.textContentForSearch || div.textContent || "").toLowerCase(); div.style.display = text.includes(term) ? 'block' : 'none'; }); }
        function clearExtractorSearch() { const i = document.getElementById('extractorSearch'); i.value = ''; filterExtractedArticles(); }
        function getLibrary() { return JSON.parse(localStorage.getItem(STORAGE_KEY_LIBRARY) || '{}'); }
        function saveLibrary(library) { localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library)); updateLibraryCount(); populateTagFilter(); if(document.getElementById('MyLibrary').style.display === 'block' && document.getElementById('duplicates-container').style.display === 'none') { loadLibrary(); } }
        function isSaved(url) { return !!getLibrary()[btoa(encodeURIComponent(url))]; }
        function toggleSaveArticle(itemData, url, btn) { const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]) { delete lib[id]; btn.innerHTML = '🤍 सेव करें'; btn.classList.remove('saved'); showToast('लाइब्रेरी से हटाया गया।', 'info'); } else { lib[id] = { ...itemData, savedAt: new Date().toISOString(), tags: [], isRead: false }; btn.innerHTML = '❤️ सेव है'; btn.classList.add('saved'); showToast('लाइब्रेरी में सेव किया गया!', 'success'); } saveLibrary(lib); }
        function getReadingStats() { const defaultStats = { totalArticlesRead: 0, totalEstimatedReadingTimeMinutes: 0, articlesReadByDate: {}, readingTimeByDate: {}, sourceCounts: {}, lastUpdated: new Date().toISOString(), trackingEnabled: true }; const storedStats = localStorage.getItem(STORAGE_KEY_STATS); if (storedStats) { try { const parsed = JSON.parse(storedStats); return { ...defaultStats, ...parsed }; } catch (e) { console.error("Error parsing stats, resetting to default:", e); return defaultStats; } } return defaultStats; }
        function saveReadingStats(stats) { stats.lastUpdated = new Date().toISOString(); localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(stats)); if (document.getElementById('settingsModal').classList.contains('show')) { displayReadingStats(); } }
        function toggleStatsTracking(isEnabled) { let stats = getReadingStats(); stats.trackingEnabled = isEnabled; saveReadingStats(stats); showToast(`आँकड़ों की ट्रैकिंग अब ${isEnabled ? 'सक्षम' : 'अक्षम'} है।`, "info"); displayReadingStats(); }
        function resetReadingStats() { if (confirm("क्या आप वाकई अपने सभी पढ़ने के आँकड़े रीसेट करना चाहते हैं? यह क्रिया वापस नहीं की जा सकती।")) { const stats = getReadingStats(); const trackingStatus = stats.trackingEnabled; localStorage.removeItem(STORAGE_KEY_STATS); const newStats = getReadingStats(); newStats.trackingEnabled = trackingStatus; saveReadingStats(newStats); displayReadingStats(); showToast("पढ़ने के आँकड़े रीसेट कर दिए गए हैं।", "success"); } }
        function calculateEstimatedReadingTime(textContent) { if (!textContent) return 0; const wordCount = textContent.split(/\s+/).filter(Boolean).length; return Math.ceil(wordCount / 200); }
        function recordArticleRead(itemData) { let stats = getReadingStats(); if (!stats.trackingEnabled) return; stats.totalArticlesRead = (stats.totalArticlesRead || 0) + 1; const readingTime = calculateEstimatedReadingTime(itemData.textContent); stats.totalEstimatedReadingTimeMinutes = (stats.totalEstimatedReadingTimeMinutes || 0) + readingTime; const today = new Date().toISOString().split('T')[0]; stats.articlesReadByDate[today] = (stats.articlesReadByDate[today] || 0) + 1; stats.readingTimeByDate[today] = (stats.readingTimeByDate[today] || 0) + readingTime; try { if (itemData.url) { const url = new URL(itemData.url); const source = url.hostname.replace(/^www\./, ''); stats.sourceCounts[source] = (stats.sourceCounts[source] || 0) + 1; } } catch (e) { console.warn("Could not parse URL for stats source:", itemData.url, e); } saveReadingStats(stats); }
        function displayReadingStats() { const stats = getReadingStats(); const statsDisplayArea = document.getElementById('statsDisplayArea'); const statsTrackingToggle = document.getElementById('statsTrackingToggle'); if (statsTrackingToggle) { statsTrackingToggle.checked = stats.trackingEnabled; } if (stats.trackingEnabled && statsDisplayArea) { statsDisplayArea.style.display = 'block'; document.getElementById('statsTotalRead').textContent = stats.totalArticlesRead; document.getElementById('statsTotalTime').textContent = stats.totalEstimatedReadingTimeMinutes; const sourceList = document.getElementById('statsSourceList'); sourceList.innerHTML = ''; const sortedSources = Object.entries(stats.sourceCounts).sort(([, a], [, b]) => b - a).slice(0, 5); if (sortedSources.length > 0) { sortedSources.forEach(([source, count]) => { const li = document.createElement('li'); li.textContent = `${source}: ${count} आइटम`; sourceList.appendChild(li); }); } else { sourceList.innerHTML = '<li>अभी कोई स्रोत डेटा नहीं है।</li>'; } } else if (statsDisplayArea) { statsDisplayArea.style.display = 'none'; } }
        function toggleReadStatus(storyId, itemUrl) { const lib = getLibrary(); if (lib[storyId]) { const wasRead = lib[storyId].isRead; lib[storyId].isRead = !lib[storyId].isRead; if (lib[storyId].isRead && !wasRead) { recordArticleRead(lib[storyId]); } saveLibrary(lib); if (libraryVirtualScrollState.isInitialized && document.getElementById('MyLibrary').style.display === 'block') { renderVisibleItems(); } } }
        function initVirtualScroll(containerId, listId, items, itemHeightEstimate) { const state = libraryVirtualScrollState; state.listContainerElement = document.getElementById(containerId); state.listElement = document.getElementById(listId); if (!state.listContainerElement || !state.listElement) { console.error("Virtual scroll container or list element not found."); state.isInitialized = false; return; } state.items = items; state.itemHeight = itemHeightEstimate; state.totalHeight = items.length * state.itemHeight; state.listElement.style.height = `${state.totalHeight}px`; state.visibleItemCount = Math.ceil(state.listContainerElement.clientHeight / state.itemHeight); if (!state.scrollHandlerAttached) { state.listContainerElement.addEventListener('scroll', handleVirtualScroll); state.scrollHandlerAttached = true; } state.isInitialized = true; state.scrollTop = state.listContainerElement.scrollTop; renderVisibleItems(); }
        function renderVisibleItems() { const state = libraryVirtualScrollState; if (!state.isInitialized || !state.listElement || !state.items) return; state.listElement.innerHTML = ''; const firstVisibleIndex = Math.floor(state.scrollTop / state.itemHeight); state.startIndex = Math.max(0, firstVisibleIndex - VIRTUAL_SCROLL_OVERSCAN); state.endIndex = Math.min(state.items.length - 1, firstVisibleIndex + state.visibleItemCount + VIRTUAL_SCROLL_OVERSCAN); const fragment = document.createDocumentFragment(); for (let i = state.startIndex; i <= state.endIndex; i++) { const itemData = state.items[i]; if (!itemData) continue; const itemDiv = createLibraryItemElement(itemData); itemDiv.style.top = `${i * state.itemHeight}px`; fragment.appendChild(itemDiv); } state.listElement.appendChild(fragment); if (state.items.length === 0 && state.listElement.innerHTML === '') { state.listElement.innerHTML = '<p style="position:static; padding:20px; text-align:center;">लाइब्रेरी खाली है या कोई परिणाम नहीं मिला।</p>'; state.listElement.style.height = 'auto'; } else if (state.items.length > 0 && state.listElement.style.height === 'auto') { state.listElement.style.height = `${state.totalHeight}px`; } }
        function handleVirtualScroll() { const state = libraryVirtualScrollState; if (state.listContainerElement) { state.scrollTop = state.listContainerElement.scrollTop; requestAnimationFrame(renderVisibleItems); } }
        function createLibraryItemElement(itemData) { const itemDiv = document.createElement('div'); itemDiv.className = 'library-item'; itemDiv.id = `lib-item-${itemData.id}`; const icon = itemData.type === 'podcast' ? '🎧' : (itemData.type === 'youtube' ? '📺' : '📄'); itemDiv.innerHTML = `<input type="checkbox" class="playlist-checkbox" data-url="${itemData.url}" onchange="updatePlaylistControls()" title="प्लेलिस्ट में जोड़ें"><span title="${itemData.type}" style="margin-right:8px;">${icon}</span><span class="item-title">${itemData.title || "N/A"}</span><div class="item-controls"><span class="read-status-toggle" title="${itemData.isRead ? 'अपठित करें' : 'पढ़ा करें'}">${itemData.isRead ? '✅' : '📖'}</span><button class="item-more-options-btn">⋮</button><button class="delete-btn">हटाएँ</button></div>`; itemDiv.querySelector('.item-title').onclick = () => { const existingQueueIndex = playQueue.findIndex(pqItem => pqItem.url === itemData.url); if (existingQueueIndex !== -1 && (isPlaying || isPaused) && audioPlayerState.currentItem?.url === itemData.url) { showSavedArticle(itemData); } else if (existingQueueIndex !== -1) { playQueueItem(existingQueueIndex); } else { clearQueue(); addToQueue(itemData); } }; itemDiv.querySelector('.read-status-toggle').onclick = (e) => { e.stopPropagation(); toggleReadStatus(itemData.id, itemData.url); }; itemDiv.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteLibraryItem(itemData.id, itemData.url); }; itemDiv.querySelector('.item-more-options-btn').onclick = (e) => { e.stopPropagation(); showItemContextMenu(e.currentTarget, itemData); }; return itemDiv; }
        function loadLibrary() { if (document.getElementById('duplicates-container').style.display !== 'none') return; document.getElementById('library-list-container').style.display = 'block'; const library = getLibrary(); const searchTerm = document.getElementById('librarySearch').value.toLowerCase(); const sortOrder = document.getElementById('librarySort').value; const selectedTag = document.getElementById('libraryTagFilter')?.value || ""; const selectedReadStatus = document.getElementById('libraryReadStatusFilter')?.value || "all"; const clearFiltersBtn = document.getElementById('clearLibraryFiltersBtn'); if (clearFiltersBtn) { clearFiltersBtn.style.display = (searchTerm || selectedTag || selectedReadStatus !== 'all') ? 'inline-block' : 'none'; } let itemsArray = Object.values(library).map(item => ({...item, id: btoa(encodeURIComponent(item.url))})); if (searchTerm) itemsArray = itemsArray.filter(item => (item.title?.toLowerCase() || "").includes(searchTerm)); if (selectedTag) itemsArray = itemsArray.filter(item => item.tags?.includes(selectedTag)); if (selectedReadStatus === "read") itemsArray = itemsArray.filter(item => item.isRead === true); else if (selectedReadStatus === "unread") itemsArray = itemsArray.filter(item => !item.isRead); itemsArray.sort((a, b) => { switch (sortOrder) { case 'date_asc': return new Date(a.savedAt) - new Date(b.savedAt); case 'title_asc': return (a.title || "").localeCompare(b.title || "", 'hi'); case 'title_desc': return (b.title || "").localeCompare(a.title || "", 'hi'); default: return new Date(b.savedAt) - new Date(a.savedAt); } }); initVirtualScroll('library-list-container', 'library-list', itemsArray, VIRTUAL_SCROLL_ITEM_HEIGHT_ESTIMATE); updatePlaylistControls(); }
        function showItemContextMenu(button, itemData) { document.querySelectorAll('.item-context-menu').forEach(menu => menu.remove()); const menu = document.createElement('div'); menu.className = 'item-context-menu'; menu.innerHTML = ` <button class="play-next-btn">▶️ अगला चलाएं</button> <button class="add-to-queue-btn">⏯️ क्यू में जोड़ें</button> `; document.body.appendChild(menu); menu.querySelector('.play-next-btn').addEventListener('click', () => { addToQueue(itemData, true); menu.remove(); }); menu.querySelector('.add-to-queue-btn').addEventListener('click', () => { addToQueue(itemData, false); menu.remove(); }); const rect = button.getBoundingClientRect(); const menuHeight = menu.offsetHeight; const menuWidth = menu.offsetWidth; let top = rect.bottom; let left = rect.right - menuWidth; if (top + menuHeight > window.innerHeight) { top = rect.top - menuHeight; } if (left < 0) { left = rect.left; } menu.style.top = `${top + window.scrollY}px`; menu.style.left = `${left + window.scrollX}px`; menu.style.display = 'block'; setTimeout(() => { document.addEventListener('click', () => menu.remove(), { once: true }); }, 0); }
        function deleteLibraryItem(storyId, url) { const lib = getLibrary(); delete lib[storyId]; saveLibrary(lib); const view = document.getElementById('library-article-view'); if (view && view.dataset.currentArticleUrl === url) { view.style.display = 'none'; view.dataset.hasContent = 'false'; hideAudioPlayer(); if(audioPlayerState.currentItem && audioPlayerState.currentItem.url === url) { stopPlayback(); audioPlayerState.currentItem = null; } } showToast("हटाया गया।"); }
        function clearLibraryFilters() { document.getElementById('librarySearch').value = ''; document.getElementById('libraryTagFilter').value = ''; document.getElementById('libraryReadStatusFilter').value = 'all'; loadLibrary(); showToast("सभी फ़िल्टर साफ़।"); }
        async function showSavedArticle(itemData) { const view = document.getElementById('library-article-view'); const contentArea = document.getElementById('lib-content-area'); const libProgressBarContainer = document.getElementById('library-reading-progress-container'); const ytControls = document.getElementById('youtube-controls'); const ytPlaybackControls = document.getElementById('youtube-playback-controls'); const audioControls = document.getElementById('audioPlayerContainer'); contentArea.innerHTML = ''; libProgressBarContainer.style.display = 'none'; ytControls.style.display = 'none'; ytPlaybackControls.style.display = 'none'; audioControls.style.display = 'none'; document.getElementById('audioOnlyToggle').checked = false; document.body.classList.remove('audio-only'); if (ytPlayer && ytPlayer.destroy) { try {ytPlayer.destroy();} catch(e){} ytPlayer = null; } document.getElementById('lib-article-title').textContent = itemData.title; document.getElementById('lib-article-original-url').href = itemData.url; document.getElementById('lib-article-original-url').textContent = itemData.url.substring(0, 60) + '...'; document.getElementById('shareLibArticleBtn').onclick = () => shareLibraryArticle(itemData); document.getElementById('toggleOriginalViewLibBtn').onclick = () => toggleOriginalWebViewForLibrary(itemData.url); const isArticle = itemData.type === 'article' || !itemData.type; document.getElementById('autoScrollControls').style.display = isArticle ? 'flex' : 'none'; document.getElementById('toggleOriginalViewLibBtn').style.display = isArticle ? 'inline-block' : 'none'; if (itemData.type === 'youtube') { const ytContainer = document.createElement('div'); ytContainer.className = 'youtube-view-library'; ytContainer.innerHTML = `<div id="library-youtube-iframe-container"><div id="library-youtube-iframe"></div></div>${itemData.textContent ? `<div class="youtube-transcript-content" style="margin-top:20px; max-height: 50vh;"><h4>ट्रांसक्रिप्ट</h4><p>${itemData.textContent}</p></div>` : ''}`; contentArea.appendChild(ytContainer); createYoutubePlayer(itemData.videoId); ytControls.style.display = 'flex'; ytPlaybackControls.style.display = 'flex'; audioPlayerState.currentItem = itemData; } else { const textEl = document.createElement('div'); textEl.id = 'lib-article-text-content'; textEl.textContent = itemData.textContent || (itemData.type === 'podcast' ? itemData.description || 'कोई विवरण नहीं।' : 'टेक्स्ट नहीं मिला।'); contentArea.appendChild(textEl); textEl.onscroll = () => { if (textEl.scrollHeight > textEl.clientHeight) { const scrollPercent = textEl.scrollTop / (textEl.scrollHeight - textEl.clientHeight); const progress = Math.min(1, Math.max(0, scrollPercent)) * 100; document.getElementById('library-reading-progress-bar').style.width = `${progress}%`; libProgressBarContainer.style.display = 'block'; } else { libProgressBarContainer.style.display = 'none'; } clearTimeout(scrollSaveTimeout); scrollSaveTimeout = setTimeout(() => { if (textEl.scrollHeight > textEl.clientHeight) { const scrollPercentForSave = textEl.scrollTop / (textEl.scrollHeight - textEl.clientHeight); if (isFinite(scrollPercentForSave)) { saveScrollPosition(itemData.url, scrollPercentForSave); } } }, 500); }; const savedScroll = getSavedScrollPosition(itemData.url); setTimeout(() => { if (savedScroll !== null && textEl.scrollHeight > textEl.clientHeight) { textEl.scrollTop = savedScroll * (textEl.scrollHeight - textEl.clientHeight); } else { textEl.scrollTop = 0; } textEl.dispatchEvent(new Event('scroll')); }, 100); if(itemData.audioUrl || itemData.textContent) audioControls.style.display = 'flex'; } const tagContainer = document.getElementById('lib-article-tags-container'); const isLibraryItem = isSaved(itemData.url); if (isLibraryItem) { tagContainer.style.display = 'block'; const libraryItem = getLibrary()[btoa(encodeURIComponent(itemData.url))]; displayArticleTags(itemData.url, libraryItem ? libraryItem.tags : []); if (libraryItem && !libraryItem.isRead && itemData.type !== 'podcast' && itemData.type !== 'youtube') { toggleReadStatus(btoa(encodeURIComponent(itemData.url)), itemData.url); } } else { tagContainer.style.display = 'none'; } applySavedLibraryFontSize(); view.style.display = 'block'; view.dataset.currentArticleUrl = itemData.url; view.dataset.hasContent = 'true'; document.querySelectorAll('.library-item.selected').forEach(el => el.classList.remove('selected')); if (isLibraryItem) { const libItemEl = document.getElementById(`lib-item-${btoa(encodeURIComponent(itemData.url))}`); if (libItemEl) libItemEl.classList.add('selected'); } openTool(null, 'MyLibrary'); view.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        function toggleOriginalWebViewForLibrary(articleUrl) { if (!articleUrl) { showToast("मूल URL नहीं मिला।", "error"); return; } const contentArea = document.getElementById('lib-content-area'); const isWebView = contentArea.querySelector('#lib-article-webview-container'); const toggleBtn = document.getElementById('toggleOriginalViewLibBtn'); const libProgressBarContainer = document.getElementById('library-reading-progress-container'); const audioPlayer = document.getElementById('audioPlayerContainer'); const autoScroll = document.getElementById('autoScrollControls'); if (isWebView) { contentArea.innerHTML = ''; showSavedArticle(audioPlayerState.currentItem); toggleBtn.textContent = '🌐 वेब व्यू दिखाएं'; } else { if (isPlaying || isPaused) pausePlayback(); Object.keys(autoScrollStates).forEach(k => {if(autoScrollStates[k].isScrolling) toggleAutoScroll(k);}); contentArea.innerHTML = `<div id="lib-article-webview-container" style="margin-top:0;"><iframe id="lib-article-iframe" src="${MY_PRIVATE_PROXY}/iframe-passthrough?url=${encodeURIComponent(articleUrl)}" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe></div>`; toggleBtn.textContent = '📖 रीडर व्यू दिखाएं'; libProgressBarContainer.style.display = 'none'; audioPlayer.style.display = 'none'; autoScroll.style.display = 'none'; } }
        function populateTagFilter() { const tags = new Set(); Object.values(getLibrary()).forEach(item => item.tags?.forEach(tag => tags.add(tag))); const sel = document.getElementById('libraryTagFilter'); const val = sel.value; sel.innerHTML = '<option value="">सभी टैग</option>'; Array.from(tags).sort((a,b) => a.localeCompare(b,'hi')).forEach(tag => sel.innerHTML += `<option value="${tag}">${tag}</option>`); sel.value = val; }
        function displayArticleTags(url, tags) { const div = document.getElementById('lib-article-current-tags'); div.innerHTML = tags?.length ? '' : '<em>कोई टैग नहीं।</em>'; tags?.forEach(tag => { const span = document.createElement('span'); span.className = 'tag-item'; span.textContent = tag; const btn = document.createElement('button'); btn.className = 'tag-remove-btn'; btn.textContent = '✗'; btn.onclick = () => removeTagFromCurrentLibraryArticle(tag); span.appendChild(btn); div.appendChild(span); }); }
        function addTagToCurrentLibraryArticle() { const input = document.getElementById('lib-new-tag-input'); const url = document.getElementById('library-article-view').dataset.currentArticleUrl; const name = input.value.trim().toLowerCase(); if (!url || !name) return; const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]) { lib[id].tags = lib[id].tags || []; if (!lib[id].tags.includes(name)) { lib[id].tags.push(name); saveLibrary(lib); displayArticleTags(url, lib[id].tags); input.value = ''; } } }
        function removeTagFromCurrentLibraryArticle(tagName) { const url = document.getElementById('library-article-view').dataset.currentArticleUrl; if (!url || !tagName) return; const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]?.tags) { lib[id].tags = lib[id].tags.filter(t => t !== tagName); saveLibrary(lib); displayArticleTags(url, lib[id].tags); } }
        async function copyLibraryArticleText() { const title = document.getElementById('lib-article-title').textContent; const currentItem = audioPlayerState.currentItem; if (!currentItem || !currentItem.textContent) { showToast('कॉपी करने के लिए टेक्स्ट नहीं मिला।', 'error'); return; } await copyArticleContent({title, textContent: currentItem.textContent}); }
        function updateLibraryCount() { document.getElementById('library-count').textContent = `(${Object.keys(getLibrary()).length})`; }
        function getBookmarks() { return JSON.parse(localStorage.getItem(STORAGE_KEY_BOOKMARKS) || '[]'); }
        function saveBookmarks(bookmarks) { localStorage.setItem(STORAGE_KEY_BOOKMARKS, JSON.stringify(bookmarks)); updateBookmarkCount(); loadBookmarks(); populateBookmarkFolderSelectors(); }
        function addBookmark() { const nameInput = document.getElementById('bookmarkName'); const urlInput = document.getElementById('bookmarkUrl'); const folderSelect = document.getElementById('bookmarkAssignFolder'); const name = nameInput.value.trim(); const url = urlInput.value.trim(); const folder = folderSelect.value; if (!url) { showToast('कृपया URL डालें', 'error'); return; } const bookmarks = getBookmarks(); bookmarks.push({ name: name || url, url: url, addedAt: new Date().toISOString(), folder: folder }); saveBookmarks(bookmarks); nameInput.value = ''; urlInput.value = ''; showToast('बुकमार्क जोड़ा गया!', 'success'); }
        function loadBookmarks() { const folderFilter = document.getElementById('bookmarkFolderFilter').value; let bookmarks = getBookmarks(); if (folderFilter) { bookmarks = bookmarks.filter(bm => bm.folder === folderFilter); } const list = document.getElementById('bookmark-list'); list.innerHTML = ''; if (bookmarks.length === 0) { list.innerHTML = '<p>कोई बुकमार्क नहीं मिला।</p>'; } else { bookmarks.forEach((bm, index) => { const div = document.createElement('div'); div.className = 'bookmark-item'; div.innerHTML = `<span class="item-title" title="${bm.url}">${bm.name}</span><button class="delete-btn">हटाएँ</button>`; div.querySelector('.item-title').onclick = () => { document.getElementById('articleUrl').value = bm.url; openTool(null, 'ArticleExtractor'); ae_startExtraction(); }; div.querySelector('.delete-btn').onclick = () => { const allBms = getBookmarks(); allBms.splice(allBms.findIndex(b => b.url === bm.url && b.addedAt === bm.addedAt), 1); saveBookmarks(allBms); }; list.appendChild(div); }); } updateBookmarkCount(); }
        function getBookmarkFolders() { const bookmarks = getBookmarks(); const folders = new Set(['Default']); bookmarks.forEach(bm => { if(bm.folder) folders.add(bm.folder) }); return Array.from(folders).sort((a,b) => a.localeCompare(b,'hi')); }
        function populateBookmarkFolderSelectors() { const folders = getBookmarkFolders(); const filterSelect = document.getElementById('bookmarkFolderFilter'); const assignSelect = document.getElementById('bookmarkAssignFolder'); const currentFilter = filterSelect.value; const currentAssign = assignSelect.value; filterSelect.innerHTML = '<option value="">सभी फ़ोल्डर</option>'; assignSelect.innerHTML = ''; folders.forEach(folder => { filterSelect.innerHTML += `<option value="${folder}">${folder}</option>`; assignSelect.innerHTML += `<option value="${folder}">${folder}</option>`; }); filterSelect.value = currentFilter; assignSelect.value = currentAssign || 'Default'; }
        function createBookmarkFolder() { const nameInput = document.getElementById('newBookmarkFolderName'); const newFolder = nameInput.value.trim(); if (newFolder) { const folders = getBookmarkFolders(); if (!folders.includes(newFolder)) { const filterSelect = document.getElementById('bookmarkFolderFilter'); const assignSelect = document.getElementById('bookmarkAssignFolder'); filterSelect.innerHTML += `<option value="${newFolder}">${newFolder}</option>`; assignSelect.innerHTML += `<option value="${newFolder}">${newFolder}</option>`; showToast(`फ़ोल्डर '${newFolder}' बनाया गया!`, 'success'); nameInput.value = ''; } else { showToast('यह फ़ोल्डर पहले से मौजूद है।', 'warning'); } } }
        function updateBookmarkCount() { document.getElementById('bookmark-count').textContent = `(${getBookmarks().length})`; }
        function adjustFontSizeSetting(area, delta) { let targetElementId, storageKey, displayElementId; if (area === 'extractor') { targetElementId = 'ae_result'; storageKey = STORAGE_KEY_FONT_SIZE; displayElementId = 'extractorFontSizeDisplay';} else if (area === 'library') { targetElementId = 'lib-content-area'; storageKey = STORAGE_KEY_LIBRARY_FONT_SIZE; displayElementId = 'libraryFontSizeDisplay';} else { return; } const targetElement = document.getElementById(targetElementId); const displayElement = document.getElementById(displayElementId); if (!targetElement || !displayElement) return; let currentSize = parseFloat(window.getComputedStyle(targetElement).fontSize); if (isNaN(currentSize)) currentSize = 16; let newSize = Math.max(10, Math.min(30, currentSize + delta)); targetElement.style.fontSize = `${newSize}px`; localStorage.setItem(storageKey, `${newSize}px`); displayElement.textContent = `${newSize}px`; }
        function applySavedFontSize() { const size = localStorage.getItem(STORAGE_KEY_FONT_SIZE) || '16px'; if (document.getElementById('ae_result')) document.getElementById('ae_result').style.fontSize = size; if(document.getElementById('extractorFontSizeDisplay')) document.getElementById('extractorFontSizeDisplay').textContent = size; }
        function applySavedLibraryFontSize() { const size = localStorage.getItem(STORAGE_KEY_LIBRARY_FONT_SIZE) || '16px'; if (document.getElementById('lib-content-area')) document.getElementById('lib-content-area').style.fontSize = size; if(document.getElementById('libraryFontSizeDisplay')) document.getElementById('libraryFontSizeDisplay').textContent = size;}
        function setFontFamily(fontStack) { document.documentElement.style.setProperty('--article-font-family', fontStack); localStorage.setItem(STORAGE_KEY_FONT_FAMILY, fontStack); const fontFamilySelect = document.getElementById('fontFamilySetting'); if (fontFamilySelect) fontFamilySelect.value = fontStack; }
        function applySavedFontFamily() { const savedFontFamily = localStorage.getItem(STORAGE_KEY_FONT_FAMILY); if (savedFontFamily) { setFontFamily(savedFontFamily); } else { const defaultFont = getComputedStyle(document.documentElement).getPropertyValue('--article-font-family').trim(); setFontFamily(defaultFont); } }
        function setDisplayMode(m) { currentDisplayMode = m; localStorage.setItem(STORAGE_KEY_DISPLAY_MODE,m); showToast(`डिस्प्ले मोड बदला गया। कंटेंट को फिर से निकालने पर लागू होगा।`, 'info');}
        function applySavedDisplayMode() { const m=localStorage.getItem(STORAGE_KEY_DISPLAY_MODE)||'image-text'; currentDisplayMode = m; document.getElementById('displayModeSetting').value = m;}
        function showToast(msg, type='info', dur=3000, actions=null) { const cont = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast-notification ${type}`; t.textContent = msg; if (actions) { const actionsDiv = document.createElement('div'); actionsDiv.className = 'toast-actions'; actions.forEach(action => { const btn = document.createElement('button'); btn.textContent = action.text; btn.onclick = () => { action.callback(); t.remove(); }; actionsDiv.appendChild(btn); }); t.appendChild(actionsDiv); } cont.appendChild(t); setTimeout(() => t.classList.add('show'), 100); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, dur); }
        function scrollToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }
        window.onscroll = function() { const btn = document.getElementById("backToTopBtn"); if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) { btn.style.display = "block"; } else { btn.style.display = "none"; } };
        function addToHistory(url) { if (currentHistoryIndex < navigationHistory.length - 1) navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1); if (navigationHistory.at(-1) !== url) { navigationHistory.push(url); currentHistoryIndex = navigationHistory.length - 1; } updateHistoryButtons(); }
        function updateHistoryButtons() { const backBtn = document.getElementById('historyBackBtn'); const fwdBtn = document.getElementById('historyForwardBtn'); const cont = document.getElementById('internalNavHistoryContainer'); cont.style.display = document.getElementById('ArticleExtractor').style.display === 'block' && navigationHistory.length > 1 ? 'flex' : 'none'; backBtn.disabled = currentHistoryIndex <= 0; fwdBtn.disabled = currentHistoryIndex >= navigationHistory.length - 1; }
        function navigateHistory(dir) { if (isNavigatingHistory) return; isNavigatingHistory = true; const newIndex = currentHistoryIndex + dir; if (newIndex >= 0 && newIndex < navigationHistory.length) { currentHistoryIndex = newIndex; document.getElementById('articleUrl').value = navigationHistory[newIndex]; ae_startExtraction(true).finally(() => isNavigatingHistory = false); } else { isNavigatingHistory = false; } }
        function updateTTSControlVisibility() { const method = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; const showVoiceSelector = method === 'local' && speechApiSupported; document.getElementById('libVoiceSelectorContainer').style.display = showVoiceSelector ? 'flex' : 'none'; document.getElementById('voiceSelectorContainerSetting').style.display = showVoiceSelector ? 'flex' : 'none'; }
        function setTTSMethod(method) { localStorage.setItem(STORAGE_KEY_TTS_METHOD, method); stopPlayback(); updateTTSControlVisibility(); showToast(`ऑडियो स्रोत अब ${method === 'stream' ? 'Google स्ट्रीम' : 'डिवाइस TTS'} है।`, 'success'); }
        function setTTSRate(rate) { const rateValue = parseFloat(rate).toFixed(1); localStorage.setItem(STORAGE_KEY_TTS_RATE, rateValue); if (currentAudioElement) { currentAudioElement.playbackRate = rateValue; } if (ytPlayer && ytPlayer.setPlaybackRate) { ytPlayer.setPlaybackRate(parseFloat(rateValue)); } document.getElementById('ttsRateDisplaySetting').textContent = `${rateValue}x`; }
        function setTTSVoice(voiceURI) { localStorage.setItem(STORAGE_KEY_TTS_VOICE, voiceURI); document.getElementById('libVoiceSelector').value = voiceURI; document.getElementById('voiceSelectorSetting').value = voiceURI; if(isPlaying && localStorage.getItem(STORAGE_KEY_TTS_METHOD) === 'local') { stopPlayback(); showToast("नई आवाज़ लागू करने के लिए ऑडियो को फिर से शुरू करें।", "info");} }
        function populateVoiceSelector() { if (!speechApiSupported || !localSpeechSynth) return; const voices = localSpeechSynth.getVoices(); if (voices.length === 0) { console.warn("getVoices() returned an empty array. Retrying in 1s."); setTimeout(populateVoiceSelector, 1000); return; } const libVoiceSelector = document.getElementById('libVoiceSelector'); const settingsVoiceSelector = document.getElementById('voiceSelectorSetting'); const currentLibVoice = libVoiceSelector.value; const currentSettingsVoice = settingsVoiceSelector.value; libVoiceSelector.innerHTML = ''; settingsVoiceSelector.innerHTML = ''; const hindiVoices = voices.filter(v => v.lang.toLowerCase().startsWith('hi')); const otherVoices = voices.filter(v => !v.lang.toLowerCase().startsWith('hi')); const createOption = (voice) => `<option value="${voice.voiceURI}">${voice.name} (${voice.lang})</option>`; let optionsHTML = ''; if (hindiVoices.length > 0) { optionsHTML += `<optgroup label="हिन्दी">` + hindiVoices.map(createOption).join('') + `</optgroup>`; } if (otherVoices.length > 0) { optionsHTML += `<optgroup label="अन्य भाषाएं">` + otherVoices.map(createOption).join('') + `</optgroup>`; } libVoiceSelector.innerHTML = optionsHTML; settingsVoiceSelector.innerHTML = optionsHTML; const savedVoice = localStorage.getItem(STORAGE_KEY_TTS_VOICE); if (savedVoice && voices.find(v => v.voiceURI === savedVoice)) { libVoiceSelector.value = savedVoice; settingsVoiceSelector.value = savedVoice; } else if (hindiVoices.length > 0) { libVoiceSelector.value = hindiVoices[0].voiceURI; settingsVoiceSelector.value = hindiVoices[0].voiceURI; localStorage.setItem(STORAGE_KEY_TTS_VOICE, hindiVoices[0].voiceURI); } else if (currentLibVoice && voices.find(v => v.voiceURI === currentLibVoice)) { libVoiceSelector.value = currentLibVoice; } else if (currentSettingsVoice && voices.find(v => v.voiceURI === currentSettingsVoice)) { settingsVoiceSelector.value = currentSettingsVoice; } else if (voices.length > 0) { libVoiceSelector.value = voices[0].voiceURI; settingsVoiceSelector.value = voices[0].voiceURI; localStorage.setItem(STORAGE_KEY_TTS_VOICE, voices[0].voiceURI); } updateTTSControlVisibility(); }
        function applySavedTTSSettings() { const savedRate = localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1.0'; document.getElementById('ttsRateSetting').value = savedRate; setTTSRate(savedRate); const savedMethod = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; document.getElementById('ttsMethodSetting').value = savedMethod; updateTTSControlVisibility(); }
        function setSleepTimer(minutes) { cancelSleepTimer(); if (minutes == 0) return; if (minutes == -1) { stopAtArticleEnd = true; document.getElementById('sleepTimerDisplay').textContent = "आइटम के अंत में रुकेगा।"; document.getElementById('cancelSleepTimerBtn').style.display = 'inline-block'; showToast("स्लीप टाइमर सेट: आइटम के अंत में रुकेगा।", "success"); } else { const durationInMs = parseInt(minutes, 10) * 60 * 1000; sleepTimerEndTime = Date.now() + durationInMs; sleepTimerId = setTimeout(() => { showToast("स्लीप टाइमर समाप्त। ऑडियो रोका जा रहा है।", "info"); stopPlayback(); cancelSleepTimer(); }, durationInMs); sleepTimerIntervalId = setInterval(updateSleepTimerDisplay, 1000); updateSleepTimerDisplay(); document.getElementById('cancelSleepTimerBtn').style.display = 'inline-block'; showToast(`${minutes} मिनट का स्लीप टाइमर सेट किया गया।`, "success"); } }
        function updateSleepTimerDisplay() { const remainingTime = sleepTimerEndTime - Date.now(); if (remainingTime <= 0) { cancelSleepTimer(); return; } const minutes = Math.floor(remainingTime / 60000); const seconds = Math.floor((remainingTime % 60000) / 1000).toString().padStart(2, '0'); document.getElementById('sleepTimerDisplay').textContent = `बाकी समय: ${minutes}:${seconds}`; }
        function cancelSleepTimer() { if (sleepTimerId) { clearTimeout(sleepTimerId); sleepTimerId = null; } if (sleepTimerIntervalId) { clearInterval(sleepTimerIntervalId); sleepTimerIntervalId = null; } stopAtArticleEnd = false; const timerDisplay = document.getElementById('sleepTimerDisplay'); if (timerDisplay) { timerDisplay.textContent = ""; document.getElementById('sleepTimerSelect').value = "0"; document.getElementById('cancelSleepTimerBtn').style.display = 'none'; } }
        function updatePlaylistControls() { const checkboxes = document.querySelectorAll('#library-list .library-item input[type="checkbox"].playlist-checkbox:checked'); const show = checkboxes.length > 0; document.getElementById('playSelectedBtn').style.display = show ? 'inline-block' : 'none'; document.getElementById('createSelectedMp3Btn').style.display = show ? 'inline-block' : 'none'; }
        function playSelectedLibraryItems() { const selectedCheckboxes = document.querySelectorAll('#library-list .library-item input[type="checkbox"].playlist-checkbox:checked'); const selectedUrls = Array.from(selectedCheckboxes).map(cb => cb.dataset.url); if (selectedUrls.length > 0) { clearQueue(); const library = getLibrary(); selectedUrls.forEach(url => { const itemId = btoa(encodeURIComponent(url)); if (library[itemId]) { addToQueue(library[itemId]); } }); startQueuePlayback(); } }
        async function createSelectedMp3() { const selectedCheckboxes = document.querySelectorAll('#library-list .library-item input[type="checkbox"].playlist-checkbox:checked'); if (selectedCheckboxes.length === 0) return; const btn = document.getElementById('createSelectedMp3Btn'); const lib = getLibrary(); let text = ''; selectedCheckboxes.forEach(cb => { const itemData = lib[btoa(encodeURIComponent(cb.dataset.url))]; if (itemData && itemData.textContent) text += `${itemData.title}.\n${itemData.textContent}\n\n`; }); await downloadTextAsMp3(text, 'playlist', btn); }
        function playNextInQueueOrAutoplay(fromRemoval = false) { let nextIndexToPlay = -1; if (!fromRemoval && currentQueueIndex < playQueue.length - 1) { nextIndexToPlay = currentQueueIndex + 1; } else if (fromRemoval && currentQueueIndex < playQueue.length) { nextIndexToPlay = currentQueueIndex; } else if (audioPlayerState.repeatMode === 'all' && playQueue.length > 0) { nextIndexToPlay = 0; } if (nextIndexToPlay !== -1 && nextIndexToPlay < playQueue.length) { playQueueItem(nextIndexToPlay); return true; } const isAutoplayOn = document.getElementById('autoPlayNextToggle').checked; if (isAutoplayOn && audioPlayerState.currentItem) { const currentUrl = audioPlayerState.currentItem.url; const allItems = libraryVirtualScrollState.items; const currentIndexInFullList = allItems.findIndex(item => item.url === currentUrl); if (currentIndexInFullList > -1 && currentIndexInFullList < allItems.length - 1) { const nextItemData = allItems[currentIndexInFullList + 1]; if (nextItemData) { clearQueue(); addToQueue(nextItemData); return true; } } } if (isPlaying || isPaused) { showToast("प्लेबैक क्यू समाप्त।", "info"); } stopPlayback(); hideAudioPlayer(); currentQueueIndex = -1; audioPlayerState.currentItem = null; updateQueueDisplay(); saveQueue(); return false; }
        function handleAutoPlayToggle(isChecked) { localStorage.setItem(STORAGE_KEY_AUTOPLAY, isChecked); }
        function updateMediaSession(item, state = 'playing') { if (!mediaSessionSupported) return; if (!item || !item.title) { navigator.mediaSession.metadata = null; navigator.mediaSession.playbackState = 'none'; return; } navigator.mediaSession.metadata = new MediaMetadata({ title: item.title, artist: item.byline || window.location.hostname, album: 'आर्टिकल रीडर प्रो', artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/864/864348.png', sizes: '512x512', type: 'image/png' }] }); navigator.mediaSession.playbackState = state; }
        const settingsModal = document.getElementById('settingsModal');
        function openSettingsModal() { loadSettingsIntoModal(); settingsModal.style.pointerEvents = 'auto'; settingsModal.classList.add('show'); window.addEventListener('keydown', handleSettingsEscKey); }
        function closeSettingsModal() { settingsModal.classList.remove('show'); setTimeout(() => { settingsModal.style.pointerEvents = 'none'; }, 300); window.removeEventListener('keydown', handleSettingsEscKey); }
        function handleSettingsEscKey(e) { if (e.key === 'Escape') { closeSettingsModal(); } }
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { closeSettingsModal(); } });
        function loadSettingsIntoModal() { const currentTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light'; const themeRadio = document.querySelector(`input[name="theme_setting"][value="${currentTheme}"]`); if(themeRadio) themeRadio.checked = true; else document.querySelector(`input[name="theme_setting"][value="light"]`).checked = true; applySavedDisplayMode(); applySavedTTSSettings(); applySavedFontSize(); applySavedLibraryFontSize(); const savedFontFamily = localStorage.getItem(STORAGE_KEY_FONT_FAMILY) || getComputedStyle(document.documentElement).getPropertyValue('--article-font-family').trim(); const fontFamilySelect = document.getElementById('fontFamilySetting'); if(fontFamilySelect) fontFamilySelect.value = savedFontFamily; displayReadingStats(); }
        document.querySelectorAll('input[name="theme_setting"]').forEach(radio => { radio.addEventListener('change', (e) => toggleTheme(e.target.value)); });
        document.getElementById('displayModeSetting').addEventListener('change', (e) => { setDisplayMode(e.target.value); });
        document.getElementById('ttsMethodSetting').addEventListener('change', (e) => { setTTSMethod(e.target.value); loadSettingsIntoModal(); });
        document.getElementById('ttsRateSetting').addEventListener('input', (e) => { setTTSRate(e.target.value); });
        document.getElementById('voiceSelectorSetting').addEventListener('change', (e) => { setTTSVoice(e.target.value); });
        document.getElementById('fontFamilySetting').addEventListener('change', (e) => { setFontFamily(e.target.value); showToast('पठन फ़ॉन्ट बदला गया।', 'success'); });
        function exportLibrary() { const library = getLibrary(); if (Object.keys(library).length === 0) { showToast("लाइब्रेरी खाली है, एक्सपोर्ट करने के लिए कुछ नहीं है।", "warning"); return; } const dataStr = JSON.stringify(library, null, 2); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr); const exportFileDefaultName = 'article_reader_library_export.json'; const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName); linkElement.click(); showToast("लाइब्रेरी एक्सपोर्ट की गई!", "success"); }
        function importLibraryHandler(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { try { const importedLibrary = JSON.parse(e.target.result); if (typeof importedLibrary === 'object' && importedLibrary !== null) { const currentLibrary = getLibrary(); const mergedLibrary = { ...currentLibrary, ...importedLibrary }; saveLibrary(mergedLibrary); showToast("लाइब्रेरी सफलतापूर्वक इंपोर्ट की गई!", "success"); loadLibrary(); } else { throw new Error("अमान्य JSON संरचना।"); } } catch (err) { showToast("लाइब्रेरी इंपोर्ट करने में त्रुटि: " + err.message, "error"); } }; reader.readAsText(file); event.target.value = null; } }
        function clearLibraryData() { if (confirm('क्या आप वाकई अपनी पूरी लाइब्रेरी हटाना चाहते हैं? यह क्रिया वापस नहीं की जा सकती।')) { localStorage.removeItem(STORAGE_KEY_LIBRARY); localStorage.removeItem(STORAGE_KEY_PLAYBACK_POSITIONS); localStorage.removeItem(STORAGE_KEY_PLAY_QUEUE); localStorage.removeItem(STORAGE_KEY_SCROLL_POSITIONS); loadLibrary(); updateLibraryCount(); const view = document.getElementById('library-article-view'); if (view) view.style.display = 'none'; audioPlayerState.currentItem = null; stopPlayback(); showToast('लाइब्रेरी साफ़ कर दी गई है।', 'success'); } }
        function clearBookmarksData() { if (confirm('क्या आप वाकई अपने सभी बुकमार्क हटाना चाहते हैं? यह क्रिया वापस नहीं की जा सकती।')) { localStorage.removeItem(STORAGE_KEY_BOOKMARKS); loadBookmarks(); updateBookmarkCount(); showToast('सभी बुकमार्क हटा दिए गए हैं।', 'success'); } }
        function resetAllSettings() { if (confirm('क्या आप वाकई सभी सेटिंग्स और डेटा को डिफ़ॉल्ट पर रीसेट करना चाहते हैं? आपकी लाइब्रेरी और बुकमार्क सहित सब कुछ हटा दिया जाएगा।')) { Object.keys(localStorage).forEach(key => { if (key.startsWith('articleReader')) { localStorage.removeItem(key); } }); showToast('सभी सेटिंग्स रीसेट कर दी गई हैं। पेज रीलोड हो रहा है...', 'success', 3000); setTimeout(() => location.reload(), 3000); } }
        function performGoogleSearch() { const query = document.getElementById('googleSearchQuery').value; if (query.trim()) { const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`; window.open(searchUrl, '_blank'); } }
        function getRssReadItems() { return JSON.parse(localStorage.getItem(STORAGE_KEY_RSS_READ_ITEMS) || '{}'); }
        function saveRssReadItems(readItems) { localStorage.setItem(STORAGE_KEY_RSS_READ_ITEMS, JSON.stringify(readItems));}
        function isRssArticleRead(feedUrl, articleLink) { const readItems = getRssReadItems(); return readItems[feedUrl] && readItems[feedUrl].includes(articleLink); }
        function markRssArticleAsRead(feedUrl, articleLink) { const readItems = getRssReadItems(); if (!readItems[feedUrl]) { readItems[feedUrl] = []; } if (!readItems[feedUrl].includes(articleLink)) { readItems[feedUrl].push(articleLink); saveRssReadItems(readItems); displaySubscribedFeeds(); } }
        function markRssArticleAsUnread(feedUrl, articleLink) { const readItems = getRssReadItems(); if (readItems[feedUrl] && readItems[feedUrl].includes(articleLink)) { readItems[feedUrl] = readItems[feedUrl].filter(link => link !== articleLink); if (readItems[feedUrl].length === 0) { delete readItems[feedUrl]; } saveRssReadItems(readItems); displaySubscribedFeeds(); } }
        function markAllRssFeedArticles(feedUrl, feedItems, asRead = true) { const readItems = getRssReadItems(); if (asRead) { if (!readItems[feedUrl]) { readItems[feedUrl] = []; } feedItems.forEach(item => { if (item && item.link && !readItems[feedUrl].includes(item.link)) { readItems[feedUrl].push(item.link); } }); } else { showToast("यह सुविधा अभी लागू नहीं है।", "warning"); return; } saveRssReadItems(readItems); const feeds = getSubscribedFeeds(); const currentFeed = feeds.find(f => f.url === feedUrl); if (currentFeed && document.getElementById('rssFeedTitleDisplay').textContent.includes(currentFeed.title || currentFeed.url) ) { displayRssArticleItems(currentFeed); } displaySubscribedFeeds(); showToast(`फ़ीड के सभी लेख पढ़े हुए चिह्नित।`, "success");}
        function getSubscribedFeeds() { return JSON.parse(localStorage.getItem(STORAGE_KEY_RSS_FEEDS) || '[]'); }
        function saveSubscribedFeeds(feeds) { localStorage.setItem(STORAGE_KEY_RSS_FEEDS, JSON.stringify(feeds)); displaySubscribedFeeds(); updateRssFeedCount(); }
        function updateRssFeedCount() { document.getElementById('rss-feed-count').textContent = `(${getSubscribedFeeds().length})`;}
        async function addRssFeed() { const urlInputEl = document.getElementById('rssFeedUrlInput'); const urlInput = urlInputEl.value.trim(); if (!urlInput) { showToast("कृपया URL डालें।", "error"); return; } showToast("RSS फ़ीड खोजा जा रहा है...", "info"); try { let feedUrl = urlInput; if (!urlInput.match(/\.(xml|rss)$/i) && !urlInput.includes('/feed')) { const foundFeedUrl = await findRssFeedUrlOnPage(urlInput); if (foundFeedUrl) { feedUrl = foundFeedUrl; showToast(`RSS फ़ीड मिला: ${feedUrl}`, "info"); } else { showToast("इस पेज पर कोई स्पष्ट RSS फ़ीड नहीं मिला। दिए गए URL को फ़ीड के रूप में इस्तेमाल करने का प्रयास किया जा रहा है।", "warning"); } } const parsedFeed = await parseRssFeed(feedUrl); if (!parsedFeed || !parsedFeed.items || parsedFeed.items.length === 0) { showToast("RSS फ़ीड को पार्स नहीं किया जा सका या उसमें कोई आइटम नहीं है।", "error"); return; } const feeds = getSubscribedFeeds(); if (feeds.some(f => f.url === feedUrl)) { showToast("यह फ़ीड पहले से सब्सक्राइब किया हुआ है।", "warning"); return; } feeds.push({ title: parsedFeed.title || feedUrl, url: feedUrl, lastFetched: new Date().toISOString(), items: parsedFeed.items.slice(0, 50), feedType: parsedFeed.feedType }); saveSubscribedFeeds(feeds); urlInputEl.value = ''; showToast(`फ़ीड "${parsedFeed.title || feedUrl}" सफलतापूर्वक जोड़ा गया!`, "success"); displayRssFeedContent(feeds.length-1); } catch (error) { console.error("फ़ीड जोड़ने में त्रुटि:", error); showToast(`फ़ीड जोड़ने में त्रुटि: ${error.message}`, "error", 5000); } }
        async function findRssFeedUrlOnPage(pageUrl) { try { const html = await fetchWithProxy(pageUrl); const parser = new DOMParser(); const doc = parser.parseFromString(html, "text/html"); const rssLink = doc.querySelector('link[type="application/rss+xml"], link[type="application/atom+xml"]'); if (rssLink && rssLink.href) return new URL(rssLink.href, pageUrl).href; return null; } catch (error) { console.warn(`पेज से RSS फ़ीड खोजने में त्रुटि ${pageUrl}:`, error); return null; } }
        async function parseRssFeed(feedUrl) { showToast(`फ़ीड ${feedUrl.substring(0,40)}... पार्स किया जा रहा है`, "info", 2000); const xmlText = await fetchWithProxy(feedUrl); const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlText, "application/xml"); const errorNode = xmlDoc.querySelector("parsererror"); if (errorNode) throw new Error("फ़ीड XML को पार्स नहीं किया जा सका।"); const feed = { title: '', items: [], feedType: 'article' }; let channelTitleElement = xmlDoc.querySelector("channel > title, feed > title"); if (channelTitleElement) feed.title = channelTitleElement.textContent.trim(); const itemElements = xmlDoc.querySelectorAll("channel > item, feed > entry"); itemElements.forEach(itemElem => { let title = itemElem.querySelector("title")?.textContent.trim(); let linkNode = itemElem.querySelector("link"); let link = linkNode?.textContent.trim() || linkNode?.getAttribute('href'); if(link && link.startsWith("//")) link = "https:" + link; if (link && !link.startsWith('http')) { try { link = new URL(link, feedUrl).href; } catch(e){ console.warn("Invalid link in feed:", link); link = null;} } const pubDate = itemElem.querySelector("pubDate, published, updated")?.textContent.trim(); let description = itemElem.querySelector("description, summary, content")?.textContent.trim(); if (description) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = description; description = (tempDiv.textContent || tempDiv.innerText || "").substring(0, 150) + "..." } const enclosure = itemElem.querySelector("enclosure"); let enclosureData = null; if (enclosure && enclosure.getAttribute('url') && enclosure.getAttribute('type')?.startsWith('audio/')) { feed.feedType = 'podcast'; enclosureData = { url: enclosure.getAttribute('url'), type: enclosure.getAttribute('type'), length: enclosure.getAttribute('length') }; } if (title && (link || enclosureData)) { feed.items.push({ title, link, pubDate, description, enclosure: enclosureData }); } }); return feed; }
        function displaySubscribedFeeds() { const feeds = getSubscribedFeeds(); const listDiv = document.getElementById('subscribedFeedsList'); listDiv.innerHTML = '<h4>सब्सक्राइब किए गए फ़ीड्स:</h4>'; if (feeds.length === 0) { listDiv.innerHTML += '<p>कोई फ़ीड सब्सक्राइब नहीं किया गया है।</p>'; document.getElementById('rssFeedTitleDisplay').textContent = ''; document.getElementById('rssArticlesList').innerHTML = ''; return; } const ul = document.createElement('ul'); feeds.forEach((feed, index) => { if (!feed || !feed.url) { console.warn("Skipping invalid feed object:", feed); return; } const li = document.createElement('li'); const feedTitleText = (feed.title || feed.url).length > 60 ? (feed.title || feed.url).substring(0, 57) + '...' : (feed.title || feed.url); let unreadCount = 0; if (feed.items && Array.isArray(feed.items) && feed.feedType !== 'podcast') { unreadCount = feed.items.filter(item => item && item.link && !isRssArticleRead(feed.url, item.link)).length; } let feedTitleDisplay = feedTitleText; if (unreadCount > 0) { feedTitleDisplay += ` <strong style="color:var(--success-color);">(${unreadCount})</strong>`; } const icon = feed.feedType === 'podcast' ? '🎧' : '📰'; li.innerHTML = ` <a href="#" onclick="displayRssFeedContent(${index}); return false;" title="${feed.title || feed.url}">${icon} ${feedTitleDisplay}</a> <div> <button class="tool-btn-secondary" onclick="refreshRssFeed(${index})" title="रिफ्रेश" style="margin-left:5px; font-size:0.8em; padding: 3px 6px; margin-top:0;">🔄</button> <button class="tool-btn-secondary danger-btn" onclick="deleteRssFeed(${index})" title="हटाएं" style="margin-left:5px; font-size:0.8em; padding: 3px 6px; margin-top:0;">✗</button> </div>`; ul.appendChild(li); }); listDiv.appendChild(ul); }
        function displayRssFeedContent(feedIndex) { const feeds = getSubscribedFeeds(); const feed = feeds[feedIndex]; if (!feed) return; if (feed.feedType === 'podcast') { displayRssPodcastEpisodes(feed); } else { displayRssArticleItems(feed); } }
        function displayRssArticleItems(feed) { document.getElementById('rssFeedTitleDisplay').textContent = `आर्टिकल: ${feed.title || feed.url}`; const articlesListDiv = document.getElementById('rssArticlesList'); articlesListDiv.innerHTML = ''; if (!feed.items || feed.items.length === 0) { articlesListDiv.innerHTML += '<p>इस फ़ीड में कोई आर्टिकल नहीं है।</p>'; return; } const headerControlsDiv = document.createElement('div'); headerControlsDiv.style.cssText = 'margin-bottom: 10px; display: flex; gap: 10px;'; const markAllReadBtn = document.createElement('button'); markAllReadBtn.textContent = 'सभी को पढ़ा चिह्नित करें'; markAllReadBtn.className = 'tool-btn-secondary'; markAllReadBtn.style.cssText = 'font-size: 0.8em; padding: 5px 10px; margin-left: 0; margin-top: 0;'; markAllReadBtn.onclick = () => { markAllRssFeedArticles(feed.url, feed.items, true); }; headerControlsDiv.appendChild(markAllReadBtn); articlesListDiv.appendChild(headerControlsDiv); feed.items.forEach(item => { if (!item || !item.link || !item.title) return; const articleDiv = document.createElement('div'); articleDiv.className = 'rss-article-item'; const isRead = isRssArticleRead(feed.url, item.link); articleDiv.style.opacity = isRead ? '0.6' : '1'; let itemHtml = `<div style="flex-grow:1;"><span class="item-title" title="${item.title}" style="font-weight:${isRead ? 'normal' : 'bold'};">${item.title}</span>`; if (item.pubDate) { itemHtml += `<br><small>प्रकाशित: ${new Date(item.pubDate).toLocaleString()}</small>`; } itemHtml += `</div><button class="rss-read-toggle-btn tool-btn-secondary" style="font-size:0.7em; padding: 3px 6px; margin-left:5px; margin-top:0; align-self:center;">${isRead ? 'अपठित करें' : 'पढ़ा करें'}</button>`; articleDiv.innerHTML = itemHtml; const titleSpan = articleDiv.querySelector('.item-title'); if (titleSpan) { titleSpan.onclick = () => { markRssArticleAsRead(feed.url, item.link); document.getElementById('articleUrl').value = item.link; openTool(null, 'ArticleExtractor'); ae_startExtraction(true); window.scrollTo(0, 0); }; } const toggleButton = articleDiv.querySelector('.rss-read-toggle-btn'); if (toggleButton) { toggleButton.onclick = (e) => { e.stopPropagation(); if (isRssArticleRead(feed.url, item.link)) { markRssArticleAsUnread(feed.url, item.link); } else { markRssArticleAsRead(feed.url, item.link); } displayRssArticleItems(feed); }; } articlesListDiv.appendChild(articleDiv); }); }
        function displayRssPodcastEpisodes(feed) { document.getElementById('rssFeedTitleDisplay').textContent = `एपिसोड: ${feed.title || feed.url}`; const listDiv = document.getElementById('rssArticlesList'); listDiv.innerHTML = ''; if (!feed.items || feed.items.length === 0) { listDiv.innerHTML = '<p>इस पॉडकास्ट में कोई एपिसोड नहीं है।</p>'; return; } feed.items.forEach(item => { if (!item || !item.title || !item.enclosure) return; const episodeDiv = document.createElement('div'); episodeDiv.className = 'rss-article-item'; let itemHtml = `<div style="flex-grow:1;"><span class="item-title" style="cursor:default; font-weight:normal;">${item.title}</span>`; if (item.pubDate) { itemHtml += `<br><small>प्रकाशित: ${new Date(item.pubDate).toLocaleString()}</small>`; } if(item.description){ itemHtml += `<p>${item.description}</p>`; } itemHtml += `</div><button class="tool-btn-secondary" style="font-size:0.8em; padding: 5px 10px; margin-left:5px; margin-top:0; align-self:center;">▶️ एपिसोड चलाएं</button>`; episodeDiv.innerHTML = itemHtml; episodeDiv.querySelector('button').onclick = () => { const podcastItemData = { type: 'podcast', title: item.title, url: item.link || item.enclosure.url, audioUrl: item.enclosure.url, byline: feed.title, textContent: item.description }; clearQueue(); addToQueue(podcastItemData); }; listDiv.appendChild(episodeDiv); }); }
        function deleteRssFeed(index) { if (!confirm("क्या आप वाकई इस RSS फ़ीड को हटाना चाहते हैं?")) return; const feeds = getSubscribedFeeds(); if (index < 0 || index >= feeds.length) { showToast("अमान्य फ़ीड इंडेक्स।", "error"); return; } const feedToDelete = feeds[index]; feeds.splice(index, 1); saveSubscribedFeeds(feeds); if (feedToDelete && feedToDelete.url) { const readItems = getRssReadItems(); if (readItems[feedToDelete.url]) { delete readItems[feedToDelete.url]; saveRssReadItems(readItems); } } if (feeds.length === 0) { document.getElementById('rssFeedTitleDisplay').textContent = ''; document.getElementById('rssArticlesList').innerHTML = ''; } else { const currentDisplayTitle = document.getElementById('rssFeedTitleDisplay').textContent; if (feedToDelete && currentDisplayTitle.includes(feedToDelete.title || feedToDelete.url)) { displayRssFeedContent(0); } } showToast("RSS फ़ीड हटाया गया।", "success"); }
        async function refreshRssFeed(index) { const feeds = getSubscribedFeeds(); if (!feeds[index]) return; const feedToRefresh = feeds[index]; const refreshBtn = document.querySelector(`#subscribedFeedsList li:nth-child(${index + 1}) button[title="रिफ्रेश"]`); const originalBtnContent = refreshBtn ? refreshBtn.innerHTML : '🔄'; if(refreshBtn) {refreshBtn.innerHTML = '...'; refreshBtn.disabled = true;} showToast(`फ़ीड "${(feedToRefresh.title || feedToRefresh.url).substring(0,30)}..." रिफ्रेश हो रहा है...`, "info"); try { const parsedFeed = await parseRssFeed(feedToRefresh.url); if (!parsedFeed || !parsedFeed.items) { showToast("फ़ीड को पार्स नहीं किया जा सका।", "error"); return; } feeds[index].items = parsedFeed.items.slice(0, 50); feeds[index].lastFetched = new Date().toISOString(); feeds[index].title = parsedFeed.title || feeds[index].title; feeds[index].feedType = parsedFeed.feedType; saveSubscribedFeeds(feeds); showToast(`फ़ीड सफलतापूर्वक रिफ्रेश किया गया!`, "success"); if (document.getElementById('rssFeedTitleDisplay').textContent.includes(feeds[index].title || feeds[index].url) || (feeds.length === 1 && index === 0) ) { displayRssFeedContent(index); } } catch (error) { console.error("फ़ीड रिफ्रेश करने में त्रुटि:", error); showToast(`फ़ीड रिफ्रेश करने में त्रुटि: ${error.message}`, "error", 5000); } finally { if(refreshBtn) {refreshBtn.innerHTML = originalBtnContent; refreshBtn.disabled = false;} } }
        async function refreshAllRssFeeds() { const feeds = getSubscribedFeeds(); if (feeds.length === 0) { showToast("रिफ्रेश करने के लिए कोई फ़ीड नहीं है।", "info"); return; } const mainRefreshBtn = document.getElementById('refreshAllRssFeedsBtn'); const originalMainBtnText = mainRefreshBtn.innerHTML; mainRefreshBtn.innerHTML = '...'; mainRefreshBtn.disabled = true; showToast(`सभी ${feeds.length} फ़ीड्स रिफ्रेश हो रहे हैं...`, "info", feeds.length * 1500); let successCount = 0; let errorCount = 0; for (let i = 0; i < feeds.length; i++) { try { const parsedFeed = await parseRssFeed(feeds[i].url); if (parsedFeed && parsedFeed.items) { feeds[i].items = parsedFeed.items.slice(0, 50); feeds[i].lastFetched = new Date().toISOString(); feeds[i].title = parsedFeed.title || feeds[i].title; feeds[i].feedType = parsedFeed.feedType; successCount++; } else { errorCount++; } } catch (error) { console.error(`फ़ीड ${feeds[i].url} रिफ्रेश करने में त्रुटि:`, error); errorCount++; } if (document.getElementById('rssFeedTitleDisplay').textContent.includes(feeds[i].title || feeds[i].url)) { displayRssFeedContent(i); } await new Promise(resolve => setTimeout(resolve, 300)); } saveSubscribedFeeds(feeds); mainRefreshBtn.innerHTML = originalMainBtnText; mainRefreshBtn.disabled = false; showToast(`${successCount} फ़ीड सफलतापूर्वक रिफ्रेश हुए। ${errorCount > 0 ? errorCount + ' में त्रुटि।' : ''}`, successCount > 0 ? "success" : "warning", 5000); }
        function clearRssFeedsData() { if (confirm('क्या आप वाकई अपने सभी RSS फ़ीड्स और पढ़े हुए आइटम का डेटा हटाना चाहते हैं?')) { localStorage.removeItem(STORAGE_KEY_RSS_FEEDS); localStorage.removeItem(STORAGE_KEY_RSS_READ_ITEMS); displaySubscribedFeeds(); updateRssFeedCount(); document.getElementById('rssFeedTitleDisplay').textContent = ''; document.getElementById('rssArticlesList').innerHTML = ''; showToast('सभी RSS फ़ीड्स और संबंधित डेटा हटा दिए गए हैं।', 'success'); } }
        function toggleFocusMode(forceState) { const body = document.body; const focusBtn = document.getElementById('focusModeToggleBtn'); let isActive; if (typeof forceState === 'boolean') { isActive = forceState; } else { isActive = !body.classList.contains('focus-mode-active'); } if (isActive) { body.classList.add('focus-mode-active'); if(focusBtn) focusBtn.innerHTML = '🧘‍♀️'; showToast("फ़ोकस मोड सक्रिय।", "info", 2000); } else { body.classList.remove('focus-mode-active'); if(focusBtn) focusBtn.innerHTML = '🧘'; showToast("फ़ोकस मोड निष्क्रिय।", "info", 2000); } localStorage.setItem(STORAGE_KEY_FOCUS_MODE, isActive); }
        function applySavedFocusMode() { const savedFocusState = localStorage.getItem(STORAGE_KEY_FOCUS_MODE) === 'true'; const focusBtn = document.getElementById('focusModeToggleBtn'); if (savedFocusState) { document.body.classList.add('focus-mode-active'); if (focusBtn) focusBtn.innerHTML = '🧘‍♀️'; } else { if (focusBtn) focusBtn.innerHTML = '🧘'; } }
        function toggleAutoScroll(articleKey, contentElementSelector, playPauseBtnSelector, speedDisplaySelector) { const contentElement = document.querySelector(contentElementSelector); const btn = document.querySelector(playPauseBtnSelector); if (!contentElement || !btn) { console.error("Auto-scroll content or button not found for key:", articleKey); return; } if (!autoScrollStates[articleKey]) { autoScrollStates[articleKey] = { intervalId: null, animationFrameId: null, speed: 50, isScrolling: false, lastScrollTime: 0 }; } const state = autoScrollStates[articleKey]; if (state.isScrolling) { if(state.animationFrameId) cancelAnimationFrame(state.animationFrameId); state.isScrolling = false; btn.textContent = '▶️ शुरू करें'; showToast("ऑटो-स्क्रॉल रोका गया।", "info"); } else { if (contentElement.scrollHeight <= contentElement.clientHeight) { showToast("स्क्रॉल करने के लिए पर्याप्त कंटेंट नहीं है।", "warning"); return; } state.isScrolling = true; btn.textContent = '⏸️ रोकें'; showToast("ऑटो-स्क्रॉल शुरू।", "success"); state.lastScrollTime = 0; function smoothScrollLoop(timestamp) { if (!state.isScrolling) return; if (!state.lastScrollTime) state.lastScrollTime = timestamp; const deltaTime = timestamp - state.lastScrollTime; state.lastScrollTime = timestamp; const pixelsPerSecond = state.speed; const scrollAmount = (pixelsPerSecond / 1000) * deltaTime; contentElement.scrollTop += scrollAmount; if (contentElement.scrollTop + contentElement.clientHeight >= contentElement.scrollHeight -1) { cancelAnimationFrame(state.animationFrameId); state.isScrolling = false; btn.textContent = '▶️ शुरू करें'; showToast("लेख का अंत। ऑटो-स्क्रॉल समाप्त।", "info"); } else { state.animationFrameId = requestAnimationFrame(smoothScrollLoop); } } state.animationFrameId = requestAnimationFrame(smoothScrollLoop); } }
        function changeAutoScrollSpeed(articleKey, delta, contentElementSelector, playPauseBtnSelector, speedDisplaySelector) { if (!autoScrollStates[articleKey]) { autoScrollStates[articleKey] = { intervalId: null, animationFrameId: null, speed: 50, isScrolling: false, lastScrollTime: 0 }; } const state = autoScrollStates[articleKey]; const speedDisplay = document.querySelector(speedDisplaySelector); state.speed += delta; if (state.speed < MIN_SCROLL_SPEED) state.speed = MIN_SCROLL_SPEED; if (state.speed > MAX_SCROLL_SPEED) state.speed = MAX_SCROLL_SPEED; if(speedDisplay) speedDisplay.textContent = `गति: ${state.speed}`; }
        function normalizeUrlForComparison(url) { try { const urlObj = new URL(url); let normalized = urlObj.hostname.replace(/^www\./, '') + urlObj.pathname; const paramsToRemove = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'fbclid', 'gclid', 'mc_eid', 'mc_cid']; const searchParams = new URLSearchParams(urlObj.search); paramsToRemove.forEach(param => searchParams.delete(param)); const sortedParams = Array.from(searchParams.entries()).sort((a, b) => a[0].localeCompare(b[0])); if (sortedParams.length > 0) { normalized += '?' + sortedParams.map(pair => `${pair[0]}=${pair[1]}`).join('&'); } return normalized.replace(/\/$/, ""); } catch (e) { return url.replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/$/, ""); } }
        function findAndDisplayDuplicates() { const library = getLibrary(); const articlesWithIds = Object.entries(library).map(([id, data]) => ({ id, ...data })); if (articlesWithIds.length < 2) { showToast("डुप्लिकेट खोजने के लिए पर्याप्त आइटम नहीं हैं।", "info"); return; } showToast("डुप्लिकेट खोजे जा रहे हैं...", "info"); const findDuplicatesBtn = document.getElementById('findDuplicatesBtn'); findDuplicatesBtn.disabled = true; findDuplicatesBtn.innerHTML = "खोज हो रही है..."; const groups = {}; articlesWithIds.forEach(article => { if (!article.url) return; const normalizedUrl = normalizeUrlForComparison(article.url); let key = normalizedUrl; if (!groups[key]) { groups[key] = []; } groups[key].push(article); }); detectedDuplicateGroups = Object.values(groups).filter(group => group.length > 1); const duplicatesContainer = document.getElementById('duplicates-container'); const duplicatesListDiv = document.getElementById('duplicates-list'); const clearDuplicatesViewBtn = document.getElementById('clearDuplicatesViewBtn'); duplicatesListDiv.innerHTML = ''; if (detectedDuplicateGroups.length > 0) { duplicatesContainer.style.display = 'block'; clearDuplicatesViewBtn.style.display = 'inline-block'; document.getElementById('library-list-container').style.display = 'none'; detectedDuplicateGroups.forEach((group, groupIndex) => { const groupDiv = document.createElement('div'); groupDiv.className = 'duplicate-group'; groupDiv.dataset.groupIndex = groupIndex; const titleText = group[0].title || group[0].url.substring(0,50) + "..."; groupDiv.innerHTML = `<h4>समूह: ${titleText} (${group.length} आइटम)</h4>`; group.forEach((article, itemIndex) => { const itemDiv = document.createElement('div'); itemDiv.className = 'duplicate-item'; itemDiv.innerHTML = ` <label for="dup_item_${groupIndex}_${itemIndex}"> <input type="radio" name="keep_group_${groupIndex}" id="dup_item_${groupIndex}_${itemIndex}" value="${article.id}" ${itemIndex === 0 ? 'checked' : ''}> ${article.title || 'N/A'} <div class="item-details"> URL: <a href="${article.url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">${article.url.substring(0,60)}...</a><br> सहेजा गया: ${new Date(article.savedAt).toLocaleString()} | टैग: ${(article.tags || []).join(', ') || 'कोई नहीं'} | ${article.isRead ? 'पढ़ा हुआ' : 'अपठित'} </div> </label> <button class="tool-btn-secondary danger-btn" onclick="deleteSingleDuplicate('${article.id}', ${groupIndex})" style="font-size:0.8em; padding: 4px 8px; margin-top:0;">हटाएँ</button> `; groupDiv.appendChild(itemDiv); }); const actionsDiv = document.createElement('div'); actionsDiv.className = 'duplicate-group-actions'; actionsDiv.innerHTML = ` <button class="tool-btn-secondary" onclick="mergeDuplicatesInGroup(${groupIndex})" style="margin-top:0; background-color:var(--success-color);">चयनित को रखें और मर्ज करें</button> <button class="tool-btn-secondary danger-btn" onclick="deleteAllInGroup(${groupIndex})" style="margin-top:0;">इस समूह के सभी हटाएँ</button> `; groupDiv.appendChild(actionsDiv); duplicatesListDiv.appendChild(groupDiv); }); showToast(`${detectedDuplicateGroups.length} डुप्लिकेट समूह मिले।`, "success"); } else { duplicatesContainer.style.display = 'none'; showToast("कोई स्पष्ट डुप्लिकेट नहीं मिला।", "info"); } findDuplicatesBtn.disabled = false; findDuplicatesBtn.innerHTML = "डुप्लिकेट खोजें"; }
        function clearDuplicatesView() { const duplicatesContainer = document.getElementById('duplicates-container'); const clearDuplicatesViewBtn = document.getElementById('clearDuplicatesViewBtn'); duplicatesContainer.style.display = 'none'; clearDuplicatesViewBtn.style.display = 'none'; document.getElementById('library-list-container').style.display = 'block'; detectedDuplicateGroups = []; loadLibrary(); }
        function deleteSingleDuplicate(articleId, groupIndex) { if (!confirm("क्या आप वाकई इस आइटम को हटाना चाहते हैं?")) return; const library = getLibrary(); delete library[articleId]; saveLibrary(library); if (detectedDuplicateGroups[groupIndex]) { detectedDuplicateGroups[groupIndex] = detectedDuplicateGroups[groupIndex].filter(article => article.id !== articleId); if (detectedDuplicateGroups[groupIndex].length < 2) { detectedDuplicateGroups.splice(groupIndex, 1); } } const remainingGroups = detectedDuplicateGroups.filter(g => g.length > 1); if (remainingGroups.length > 0) { const currentDupGroups = [...detectedDuplicateGroups]; detectedDuplicateGroups = []; findAndDisplayDuplicates(); detectedDuplicateGroups = currentDupGroups.filter(g => g.length > 1); } else { clearDuplicatesView(); } showToast("आइटम हटाया गया।", "success"); }
        function mergeDuplicatesInGroup(groupIndex) { const group = detectedDuplicateGroups[groupIndex]; if (!group || group.length < 2) return; const selectedRadio = document.querySelector(`input[name="keep_group_${groupIndex}"]:checked`); if (!selectedRadio) { showToast("कृपया रखने के लिए एक आइटम चुनें।", "warning"); return; } const idToKeep = selectedRadio.value; const library = getLibrary(); const articleToKeepData = library[idToKeep]; if (!articleToKeepData) { showToast("रखने के लिए चयनित आइटम नहीं मिला।", "error"); findAndDisplayDuplicates(); return; } const finalArticle = JSON.parse(JSON.stringify(articleToKeepData)); let mergedTags = new Set(finalArticle.tags || []); let wasAnyUnread = !finalArticle.isRead; let mostRecentDate = new Date(finalArticle.savedAt).getTime(); let longestContent = (finalArticle.content || finalArticle.textContent || "").length; group.forEach(article => { const currentArticleData = library[article.id]; if (!currentArticleData) return; if (article.id !== idToKeep) { (currentArticleData.tags || []).forEach(tag => mergedTags.add(tag)); if (!currentArticleData.isRead) { wasAnyUnread = true; } if (new Date(currentArticleData.savedAt).getTime() > mostRecentDate) { mostRecentDate = new Date(currentArticleData.savedAt).getTime(); } const currentContentLength = (currentArticleData.content || currentArticleData.textContent || "").length; if (currentContentLength > longestContent) { longestContent = currentContentLength; finalArticle.content = currentArticleData.content; finalArticle.textContent = currentArticleData.textContent; } delete library[article.id]; } }); finalArticle.tags = Array.from(mergedTags); finalArticle.isRead = !wasAnyUnread; finalArticle.savedAt = new Date(mostRecentDate).toISOString(); library[idToKeep] = finalArticle; saveLibrary(library); detectedDuplicateGroups.splice(groupIndex, 1); const remainingGroups = detectedDuplicateGroups.filter(g => g.length > 1); if (remainingGroups.length > 0) { findAndDisplayDuplicates(); } else { clearDuplicatesView(); } showToast("डुप्लिकेट सफलतापूर्वक मर्ज किए गए।", "success"); }
        function deleteAllInGroup(groupIndex) { const group = detectedDuplicateGroups[groupIndex]; if (!group || !confirm(`क्या आप वाकई इस समूह के सभी ${group.length} आइटम को हटाना चाहते हैं?`)) return; const library = getLibrary(); group.forEach(article => { delete library[article.id]; }); saveLibrary(library); detectedDuplicateGroups.splice(groupIndex, 1); const remainingGroups = detectedDuplicateGroups.filter(g => g.length > 1); if (remainingGroups.length > 0) { findAndDisplayDuplicates(); } else { clearDuplicatesView(); } showToast("समूह के सभी आइटम हटा दिए गए।", "success"); }
        
        function onYouTubeIframeAPIReady() { console.log("YouTube IFrame API is ready."); }
        function createYoutubePlayer(videoId) { if (ytPlayer && ytPlayer.destroy) { try {ytPlayer.destroy();} catch(e){} ytPlayer = null; } ytPlayer = new YT.Player('library-youtube-iframe', { height: '450', width: '100%', videoId: videoId, playerVars: { 'playsinline': 1, 'autoplay': 1, 'origin': window.location.origin }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } }); }
        function onPlayerReady(event) { event.target.setPlaybackRate(parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1')); const availableQualities = event.target.getAvailableQualityLevels(); const qualityButtonsDiv = document.getElementById('quality-buttons'); qualityButtonsDiv.innerHTML = '<label>गुणवत्ता:</label>'; availableQualities.forEach(quality => { const btn = document.createElement('button'); btn.textContent = quality; btn.className = 'tool-btn-secondary'; btn.style.cssText = 'padding: 4px 8px; font-size: 0.8em; margin-left: 5px; margin-top: 0;'; btn.onclick = () => { if(ytPlayer) ytPlayer.setPlaybackQuality(quality); showToast(`गुणवत्ता ${quality} पर सेट की गई।`, 'info'); }; qualityButtonsDiv.appendChild(btn); }); event.target.playVideo(); }
        function onPlayerStateChange(event) { const playPauseBtn = document.getElementById('youtube-play-pause-btn'); if (event.data == YT.PlayerState.PLAYING) { isPlaying = true; isPaused = false; if (playPauseBtn) playPauseBtn.innerHTML = '⏸️'; updateMediaSession(audioPlayerState.currentItem, 'playing'); } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.CUED) { isPlaying = false; isPaused = true; if (playPauseBtn) playPauseBtn.innerHTML = '▶️'; updateMediaSession(audioPlayerState.currentItem, 'paused'); } if (event.data == YT.PlayerState.ENDED) { playNextInQueueOrAutoplay(); } }
        function toggleYoutubePlayback() { if (ytPlayer && typeof ytPlayer.getPlayerState === 'function') { const playerState = ytPlayer.getPlayerState(); if (playerState === YT.PlayerState.PLAYING) { ytPlayer.pauseVideo(); } else { ytPlayer.playVideo(); } } }
        function toggleAudioOnlyMode(isChecked) { if (isChecked) { document.body.classList.add('audio-only'); showToast("केवल-ऑडियो मोड चालू।", 'info'); } else { document.body.classList.remove('audio-only'); showToast("केवल-ऑडियो मोड बंद।", 'info'); } }

        document.addEventListener('DOMContentLoaded', () => {
            loadQueue();
            applySavedTheme();
            updateLibraryCount(); updateBookmarkCount(); updateRssFeedCount();
            applySavedFontSize(); applySavedLibraryFontSize(); applySavedFontFamily();
            applySavedDisplayMode();
            applySavedFocusMode();
            toggleDepthSelector(); populateTagFilter(); populateBookmarkFolderSelectors();
            if (speechApiSupported) {
                localSpeechSynth = window.speechSynthesis;
                const loadVoices = () => { if (localSpeechSynth.getVoices().length > 0) { populateVoiceSelector(); } };
                loadVoices();
                if (localSpeechSynth.onvoiceschanged !== undefined) {
                    localSpeechSynth.onvoiceschanged = loadVoices;
                }
            }
            applySavedTTSSettings();
            const autoPlay = localStorage.getItem(STORAGE_KEY_AUTOPLAY) === 'true';
            if (autoPlay) document.getElementById('autoPlayNextToggle').checked = true;
            if (!localStorage.getItem(STORAGE_KEY_STATS)) {
                saveReadingStats(getReadingStats());
            }
            document.addEventListener('visibilitychange', () => {});
            window.addEventListener('beforeunload', () => { if (isPlaying || isPaused) { stopPlayback(); } });
            if (mediaSessionSupported) {
                navigator.mediaSession.setActionHandler('play', () => handlePlayPause());
                navigator.mediaSession.setActionHandler('pause', () => handlePlayPause());
                navigator.mediaSession.setActionHandler('stop', () => stopPlayback());
                navigator.mediaSession.setActionHandler('previoustrack', () => playPreviousInQueue());
                navigator.mediaSession.setActionHandler('nexttrack', () => playNextInQueueOrAutoplay());
            }
            
            document.getElementById('googleSearchQuery')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); performGoogleSearch(); }});
            document.getElementById('youtubeSearchQuery')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchYouTube(); }});

            document.addEventListener('click', function(event) {
                let target = event.target.closest('a[data-reader-target-url]');
                if(target) {
                    event.preventDefault();
                    const urlToLoad = target.getAttribute('data-reader-target-url');
                    document.getElementById('articleUrl').value = urlToLoad;
                    ae_startExtraction(true);
                    return;
                }

                let link = event.target.closest('a');
                if (link && link.href && !link.hasAttribute('data-reader-target-url')) {
                    try {
                        const url = new URL(link.href);
                        if (url.hostname.includes('youtube.com') || url.hostname.includes('youtu.be')) {
                            event.preventDefault();
                            showToast('YouTube लिंक को ऐप में प्रोसेस किया जा रहा है...', 'info');
                            document.getElementById('articleUrl').value = link.href;
                            const extractorTabButton = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
                            openTool({ currentTarget: extractorTabButton }, 'ArticleExtractor');
                            ae_startExtraction(true);
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    } catch(e) { /* Not a valid URL, do nothing */ }
                }
            }, true);

            const p=new URLSearchParams(window.location.search),url=p.get('url');
            if(url){
                const i=document.getElementById('articleUrl');
                if(i)i.value=url;
                const extractorTabButton = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
                if (extractorTabButton) {
                    if (!extractorTabButton.classList.contains('active')) {
                         openTool({ currentTarget: extractorTabButton }, 'ArticleExtractor');
                    }
                    ae_startExtraction();
                }
            } else {
               const tab=document.querySelector('.tab-link');
               if(tab) openTool({currentTarget:tab},'ArticleExtractor');
            }
            updateHistoryButtons();
            updatePlayerUI();
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    try {
                        const proxyHost = new URL(MY_PRIVATE_PROXY).hostname;
                        const dynamicServiceWorkerCode = createServiceWorkerCode(proxyHost);
                        const blob = new Blob([dynamicServiceWorkerCode], { type: 'application/javascript' });
                        navigator.serviceWorker.register(URL.createObjectURL(blob))
                            .then(reg => console.log('ServiceWorker registered for proxy host:', proxyHost))
                            .catch(err => console.error('ServiceWorker registration failed:', err));
                    } catch (e) {
                        console.error('ServiceWorker setup failed:', e);
                    }
                });
            }
        });
    </script>
</body>
</html>